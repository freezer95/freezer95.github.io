<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-cn">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="formily,">










<meta name="description" content="Formily 作为目前最流行的复杂表单解决方案之一，提供了面向“数据关联，逻辑联动，校验联动”等业务层代码的解决方案。本篇文章适用于有一定 Formily 使用经验的同学，进一步了解 Formily 的设计和实现，适用于版本 v1.1.4。">
<meta name="keywords" content="formily">
<meta property="og:type" content="article">
<meta property="og:title" content="Formily 架构及实现">
<meta property="og:url" content="https://freezer95.github.io/2020/09/11/formily/index.html">
<meta property="og:site_name" content="Freezer&#39;s Blog">
<meta property="og:description" content="Formily 作为目前最流行的复杂表单解决方案之一，提供了面向“数据关联，逻辑联动，校验联动”等业务层代码的解决方案。本篇文章适用于有一定 Formily 使用经验的同学，进一步了解 Formily 的设计和实现，适用于版本 v1.1.4。">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="https://freezer95.github.io/images/formily_structure_file.png">
<meta property="og:image" content="https://freezer95.github.io/images/formily_structure_layer.png">
<meta property="og:image" content="https://freezer95.github.io/images/formily_schema.png">
<meta property="og:image" content="https://freezer95.github.io/images/formily_qa_1.png">
<meta property="og:updated_time" content="2020-09-11T10:51:09.823Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Formily 架构及实现">
<meta name="twitter:description" content="Formily 作为目前最流行的复杂表单解决方案之一，提供了面向“数据关联，逻辑联动，校验联动”等业务层代码的解决方案。本篇文章适用于有一定 Formily 使用经验的同学，进一步了解 Formily 的设计和实现，适用于版本 v1.1.4。">
<meta name="twitter:image" content="https://freezer95.github.io/images/formily_structure_file.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://freezer95.github.io/2020/09/11/formily/">





  <title>Formily 架构及实现 | Freezer's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-cn">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Freezer's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://freezer95.github.io/2020/09/11/formily/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Freezer">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Freezer's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Formily 架构及实现</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-11T16:49:16+08:00">
                2020-09-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          
              <div class="post-description">
                  Formily 作为目前最流行的复杂表单解决方案之一，提供了面向“数据关联，逻辑联动，校验联动”等业务层代码的解决方案。本篇文章适用于有一定 Formily 使用经验的同学，进一步了解 Formily 的设计和实现，适用于版本 v1.1.4。
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>Formily 是一个由阿里巴巴集团多 BU 共建的面向中后台复杂场景的表单解决方案，它也是一个表单框架。<br>它的前身是供应链平台在 2019 年初对外开源的 UForm 解决方案，UForm 的前身又是在供应链平台内部自研的某个表单框架。</p>
</blockquote>
<p>官方文档：<a href="https://formilyjs.org/#/bdCRC5/dzUZU8il" target="_blank" rel="noopener">Formily</a>、<a href="https://uform-next.netlify.app/#/MpI2Ij/rRCmCPsOHO" target="_blank" rel="noopener">Uform</a><br>Formily 作为目前最流行的复杂表单解决方案之一，提供了面向“数据关联，逻辑联动，校验联动”等业务层代码的解决方案。本篇文章<strong>适用于有一定 Formily 使用经验的同学</strong>，进一步了解 Formily 的设计和实现，适用于版本 <a href="https://github.com/alibaba/formily/releases/tag/v1.1.4" target="_blank" rel="noopener">v1.1.4</a>。</p>
<h1 id="架构篇"><a href="#架构篇" class="headerlink" title="架构篇"></a>架构篇</h1><p>Fomily 拆分成了多包，通过 Lerna 管理，具体的分包如下图。面对这么多包，你是否感觉无从下手？这里，我们可以从架构切入，先了解 Formily 的架构。<br><img src="/images/formily_structure_file.png" width="100%"></p>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><p><a href="https://formilyjs.org/#/bdCRC5/dzUZU8il" target="_blank" rel="noopener">Fomily</a> 官方文档的架构图和相关说明如下。自底向上，值得重点关注两个层次： </p>
<ol>
<li>核心库：@Formily/core。core 仅依赖于 validator 和 shared，设计上与框架、组件库完全解耦；</li>
<li>协议层：Schema Editor。定制标准表单协议，设计上使一份协议多端多组件库通用成为可能。</li>
</ol>
<img src="/images/formily_structure_layer.png" width="100%">

<blockquote>
<ul>
<li>UI 桥接层(React/Vue/Angular/小程序….)，这一层主要是对接各种组件化框架，对不同体系的用户提供更便捷的表单管理方案</li>
<li>Schema 动态渲染层(React/Vue/Angular/小程序…)，这一层主要提供了针对 Schema 场景下的各种上层能力，比如典型的协议化联动，协议化布局能力</li>
<li>Schema 编辑器层，这一层主要提供了可视化配置 Schema 能力，方便非技术人员快速配置表单</li>
<li>研发工具层，这一层主要提供了针对 Formily 的开发者调试能力</li>
</ul>
</blockquote>
<h2 id="架构实践"><a href="#架构实践" class="headerlink" title="架构实践"></a>架构实践</h2><p>了解 Formily 的架构设计后，接下来结合 Formily 实际分包和包之间的依赖分析。</p>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>下载 Fomily 源码，，切换到指定 tag: <a href="https://github.com/alibaba/formily/releases/tag/v1.1.4" target="_blank" rel="noopener">v1.1.4</a></p>
<h3 id="全量的-Dependency-Graph"><a href="#全量的-Dependency-Graph" class="headerlink" title="全量的 Dependency Graph"></a>全量的 Dependency Graph</h3><p>执行以下命令打印 formily 包之间的 dependency<br>注：相关知识详见 <a href="https://github.com/lerna/lerna/blob/master/commands/list#readme" target="_blank" rel="noopener">lerna/commands/list</a>、<a href="https://man.linuxde.net/grep" target="_blank" rel="noopener">Linux grep 命令</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lerna ls --graph | grep -e @formily -e ], -e ]  -e &#123; -e &#125;</span><br></pre></td></tr></table></figure>

<p>打印结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"@formily/antd-components"</span>: [</span><br><span class="line">    <span class="string">"@formily/antd"</span>,</span><br><span class="line">    <span class="string">"@formily/react-schema-renderer"</span>,</span><br><span class="line">    <span class="string">"@formily/react-shared-components"</span>,</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/antd"</span>: [</span><br><span class="line">    <span class="string">"@formily/react-schema-renderer"</span>,</span><br><span class="line">    <span class="string">"@formily/react-shared-components"</span>,</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/core"</span>: [</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">    <span class="string">"@formily/validator"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/devtools"</span>: [</span><br><span class="line">    <span class="string">"@formily/core"</span>,</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/meet-components"</span>: [</span><br><span class="line">    <span class="string">"@formily/react"</span>,</span><br><span class="line">    <span class="string">"@formily/react-schema-renderer"</span>,</span><br><span class="line">    <span class="string">"@formily/react-shared-components"</span>,</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/meet"</span>: [</span><br><span class="line">    <span class="string">"@formily/react"</span>,</span><br><span class="line">    <span class="string">"@formily/react-schema-renderer"</span>,</span><br><span class="line">    <span class="string">"@formily/react-shared-components"</span>,</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/next-components"</span>: [</span><br><span class="line">    <span class="string">"@formily/next"</span>,</span><br><span class="line">    <span class="string">"@formily/react-schema-renderer"</span>,</span><br><span class="line">    <span class="string">"@formily/react-shared-components"</span>,</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/next"</span>: [</span><br><span class="line">    <span class="string">"@formily/react-schema-renderer"</span>,</span><br><span class="line">    <span class="string">"@formily/react-shared-components"</span>,</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/printer"</span>: [</span><br><span class="line">    <span class="string">"@formily/react-schema-renderer"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/react-schema-editor"</span>: [</span><br><span class="line">    <span class="string">"@formily/antd"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/react-schema-renderer"</span>: [</span><br><span class="line">    <span class="string">"@formily/core"</span>,</span><br><span class="line">    <span class="string">"@formily/react"</span>,</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">    <span class="string">"@formily/validator"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/react-shared-components"</span>: [</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/react"</span>: [</span><br><span class="line">    <span class="string">"@formily/core"</span>,</span><br><span class="line">    <span class="string">"@formily/shared"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/shared"</span>: [</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/validator"</span>: [</span><br><span class="line">    <span class="string">"@formily/shared"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="代表性的-Dependency-Graph"><a href="#代表性的-Dependency-Graph" class="headerlink" title="代表性的 Dependency Graph"></a>代表性的 Dependency Graph</h3><p>自底向上（暂不考虑纵向的 Formily DevTools），整理各个层级的代表包后，依赖如下（以 Antd 为代表，忽略非必须的扩展包）：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"@formily/shared"</span>: [</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/validator"</span>: [</span><br><span class="line">    <span class="string">"@formily/shared"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/react-shared-components"</span>: [</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/core"</span>: [</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">    <span class="string">"@formily/validator"</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"@formily/react"</span>: [</span><br><span class="line">    <span class="string">"@formily/core"</span>,</span><br><span class="line">    <span class="string">"@formily/shared"</span></span><br><span class="line">  ], <span class="comment">// UI 桥接层(React/Vue/Angular/小程序....)，这一层主要是对接各种组件化框架，对不同体系的用户提供更便捷的表单管理方案</span></span><br><span class="line">  <span class="attr">"@formily/react-schema-renderer"</span>: [</span><br><span class="line">    <span class="string">"@formily/core"</span>,</span><br><span class="line">    <span class="string">"@formily/react"</span>,</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">    <span class="string">"@formily/validator"</span>,</span><br><span class="line">  ], <span class="comment">// Schema 动态渲染层(React/Vue/Angular/小程序...)，这一层主要提供了针对 Schema 场景下的各种上层能力，比如典型的协议化联动，协议化布局能力</span></span><br><span class="line">  <span class="attr">"@formily/antd"</span>: [</span><br><span class="line">    <span class="string">"@formily/react-schema-renderer"</span>,</span><br><span class="line">    <span class="string">"@formily/react-shared-components"</span>,</span><br><span class="line">    <span class="string">"@formily/shared"</span>,</span><br><span class="line">  ], <span class="comment">// UI 组件层</span></span><br><span class="line">  <span class="attr">"@formily/react-schema-editor"</span>: [</span><br><span class="line">    <span class="string">"@formily/antd"</span>,</span><br><span class="line">  ], <span class="comment">// Schema 编辑器层，这一层主要提供了可视化配置 Schema 能力，方便非技术人员快速配置表单</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实现篇"><a href="#实现篇" class="headerlink" title="实现篇"></a>实现篇</h1><p>本篇分析上述代表性的包的实现，会涉及到较多源码</p>
<h2 id="基础库-formily-shared"><a href="#基础库-formily-shared" class="headerlink" title="基础库 - @formily/shared"></a>基础库 - @formily/shared</h2><h3 id="路径定位系统-FormPath"><a href="#路径定位系统-FormPath" class="headerlink" title="路径定位系统 - FormPath"></a>路径定位系统 - FormPath</h3><blockquote>
<p>FormPath/FormPathPattern 是一个抽象数据路径形式，FormPath 是路径类 ，FormPathPattern 是可以被 FormPath 解析的路径形式，在这里主要使用了 <a href="https://github.com/janrywang/cool-path" target="_blank" rel="noopener">cool-path</a> 路径解析匹配，求值取值能力</p>
</blockquote>
<p>上面的说法看着莫名难懂，下面看看代码实现：<br>@formily/shared - 相关代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> FormPath, &#123; Pattern <span class="keyword">as</span> FormPathPattern &#125; <span class="keyword">from</span> <span class="string">'cool-path'</span></span><br></pre></td></tr></table></figure>

<p>cool-path - Pattern 相关代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type Pattern = string | number | Path | Segments | MatcherFunction</span><br></pre></td></tr></table></figure>

<p>cool-path - FormPath 相关代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Path</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(input: Pattern) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Path</span><br></pre></td></tr></table></figure>

<p>所以 FormPath 其实就是 cool-path 包中的 Path，FormPathPattern 就是入参类型。支持的 API 和 Path Match Pattern Syntax 详见：<a href="https://github.com/janrywang/cool-path" target="_blank" rel="noopener">cool-path</a>。我们在 Fomily 中常用的以下 “路径模式”，就是 cool-path 支持的。当然，也可以使用 cool-path 支持的其他 “路径模式”。<br>Expand String</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"aaa~"</span> or <span class="string">"~"</span> or <span class="string">"aaa~.bbb.cc"</span></span><br></pre></td></tr></table></figure>

<p>Part Wildcard</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"a.b.*.c.*"</span></span><br></pre></td></tr></table></figure>

<h2 id="校验库-formily-validator"><a href="#校验库-formily-validator" class="headerlink" title="校验库 - @formily/validator"></a>校验库 - @formily/validator</h2><h3 id="校验系统-FormValidator"><a href="#校验系统-FormValidator" class="headerlink" title="校验系统 - FormValidator"></a>校验系统 - FormValidator</h3><p>表单校验类，创建表单时，自动在内部创建一个 FormValidator 实例，根据不同 path 管理校验器。<strong>了解这部分代码实现，能对 Formily 中 validator 的设计有清晰认知。</strong></p>
<h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>FormValidator 提供了以下两个重要的实例方法，用法详见下方的单元测试部分。</p>
<ul>
<li>register: 注册校验规则，将校验规则保存到名为 nodes 的私有变量集合中，key 为路径FormPath.parse(path || name)，value 为封装了校验规则、校验信息重组等功能的校验器。</li>
<li>validate: 执行校验，遍历私有变量 nodes，寻找 path 匹配的校验器，使用校验器校验数据，返回校验结果。</li>
</ul>
<p>此外，FormValidator 还提供了一些静态方法：</p>
<ul>
<li>FormValidator.registerRules: 注册校验规则，实例化 FormValidator 时，会自动注册一些默认值，如常见的 required、pattern 等。</li>
<li>FormValidator.registerFormats：注册校验正则，在校验器执行时，先转换为校验规则的 pattern 类型。</li>
<li>FormValidator.registerMTEngine：注册校验信息模板方法，如在信息字符串中写，在方法中替换为校验器提供的 context 中对应路径的值。</li>
</ul>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 校验规则集合</span></span><br><span class="line"><span class="keyword">const</span> ValidatorRules = &#123;</span><br><span class="line">  required(value: any, <span class="attr">rule</span>: ValidateDescription, <span class="attr">rules</span>: ValidateRulesMap) &#123;</span><br><span class="line">    <span class="keyword">if</span> (rule.required === <span class="literal">false</span>) <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">    <span class="keyword">return</span> isValidateEmpty(value) ? getRuleMessage(rule, <span class="string">'required'</span>, rules) : <span class="string">''</span></span><br><span class="line">  &#125;,</span><br><span class="line">  pattern(value: any, <span class="attr">rule</span>: ValidateDescription, <span class="attr">rules</span>: ValidateRulesMap) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isValidateEmpty(value)) <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">new</span> <span class="built_in">RegExp</span>(rule.pattern).test(value)</span><br><span class="line">      ? getRuleMessage(rule, <span class="string">'pattern'</span>, rules)</span><br><span class="line">      : <span class="string">''</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...省略其他默认值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 校验正则集合</span></span><br><span class="line"><span class="keyword">const</span> ValidatorFormators = &#123;</span><br><span class="line">  number: <span class="regexp">/^[+-]?\d+(\.\d+)?$/</span>,</span><br><span class="line">  <span class="comment">// ...省略其他默认值</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用校验信息模板方法重组校验信息</span></span><br><span class="line"><span class="keyword">const</span> template = (message, context): <span class="function"><span class="params">string</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (isStr(message)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isFn(FormValidator.template)) &#123;</span><br><span class="line">      <span class="keyword">return</span> FormValidator.template(message, context)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> message.replace(<span class="regexp">/\&#123;\&#123;\s*([\w.]+)\s*\&#125;\&#125;/g</span>, (_, $<span class="number">0</span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">return</span> FormPath.getIn(context, $<span class="number">0</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isObj(message) &amp;&amp; !message[<span class="string">'$$typeof'</span>] &amp;&amp; !message[<span class="string">'_owner'</span>]) &#123;</span><br><span class="line">    <span class="keyword">return</span> template(message.message, context)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> message <span class="keyword">as</span> any</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FormValidator</span> </span>&#123;</span><br><span class="line">  private nodes</span><br><span class="line">  <span class="keyword">static</span> template</span><br><span class="line">  <span class="comment">//注册通用规则</span></span><br><span class="line">  <span class="keyword">static</span> registerRules(rules: ValidateRulesMap) &#123;</span><br><span class="line">    each(rules, (rule, key) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (isFn(rule)) &#123;</span><br><span class="line">        ValidatorRules[key] = rule</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="comment">// 注册通用正则</span></span><br><span class="line">  <span class="keyword">static</span> registerFormats(formats: ValidateFormatsMap) &#123;</span><br><span class="line">    each(formats, (pattern, key) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (isStr(pattern) || pattern <span class="keyword">instanceof</span> <span class="built_in">RegExp</span>) &#123;</span><br><span class="line">        ValidatorFormators[key] = <span class="keyword">new</span> <span class="built_in">RegExp</span>(pattern)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 注册校验信息模板方法</span></span><br><span class="line">  <span class="keyword">static</span> registerMTEngine = <span class="function"><span class="params">template</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isFn(template)) &#123;</span><br><span class="line">      FormValidator.template = template</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册校验规则</span></span><br><span class="line">  register (path, calculator) &#123;</span><br><span class="line">    <span class="keyword">this</span>.nodes[path] = <span class="function">(<span class="params">options</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> tmpResult: any</span><br><span class="line">        <span class="keyword">const</span> validate = <span class="keyword">async</span> (value, rules) =&gt; &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>._internalValidate(</span><br><span class="line">            value,</span><br><span class="line">            <span class="keyword">this</span>._transformRules(rules), <span class="comment">// 预处理 rules</span></span><br><span class="line">            options</span><br><span class="line">          ).then(</span><br><span class="line">            payload =&gt; &#123;</span><br><span class="line">              tmpResult = payload</span><br><span class="line">              <span class="keyword">return</span> payload</span><br><span class="line">            &#125;,</span><br><span class="line">            payload =&gt; &#123;</span><br><span class="line">              tmpResult = payload</span><br><span class="line">              <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(payload)</span><br><span class="line">            &#125;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">Promise</span>.resolve(calculator(validate)).then(</span><br><span class="line">          () =&gt; &#123;</span><br><span class="line">            resolve(tmpResult)</span><br><span class="line">          &#125;,</span><br><span class="line">          () =&gt; &#123;</span><br><span class="line">            reject(tmpResult)</span><br><span class="line">          &#125;</span><br><span class="line">        )</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 预处理 rules，如:将校验正则转换为校验规则 pattern </span></span><br><span class="line">  _transformRules(rules: ValidatePatternRules) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isStr(rules)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!ValidatorFormators[rules]) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Can not found validator pattern'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> [</span><br><span class="line">        &#123;</span><br><span class="line">          pattern: ValidatorFormators[rules],</span><br><span class="line">          message: getMessage(rules) || <span class="string">'Can not found validator message.'</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isFn(rules)) &#123;</span><br><span class="line">      <span class="keyword">return</span> [</span><br><span class="line">        &#123;</span><br><span class="line">          validator: rules</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isArr(rules)) &#123;</span><br><span class="line">      <span class="keyword">return</span> rules.reduce(<span class="function">(<span class="params">buf: any, rule</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> buf.concat(<span class="keyword">this</span>._transformRules(rule))</span><br><span class="line">      &#125;, [])</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isObj(rules)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (rules.format) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!ValidatorFormators[rules.format]) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Can not found validator pattern'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        rules.pattern = ValidatorFormators[rules.format]</span><br><span class="line">        rules.message = rules.message || getMessage(rules.format)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> [rules]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> []</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 调用匹配的校验规则函数，获取校验信息，并通过校验信息模板方法重组校验信息</span></span><br><span class="line">  <span class="keyword">async</span> _internalValidate( value, rules ) &#123;</span><br><span class="line">    <span class="keyword">const</span> errors = []</span><br><span class="line">    <span class="keyword">const</span> warnings = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; rules.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> ruleObj = rules[i]</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> l = <span class="number">0</span>; l &lt; keys.length; l++) &#123;</span><br><span class="line">        <span class="keyword">const</span> key = keys[l]</span><br><span class="line">        <span class="keyword">if</span> (ruleObj.hasOwnProperty(key) &amp;&amp; isValid(ruleObj[key])) &#123;</span><br><span class="line">          <span class="keyword">const</span> rule = ValidatorRules[key]</span><br><span class="line">          <span class="keyword">if</span> (rule) &#123;</span><br><span class="line">            <span class="keyword">const</span> payload = <span class="keyword">await</span> rule(value, ruleObj, ValidatorRules)</span><br><span class="line">            <span class="keyword">const</span> message = template(payload, &#123;</span><br><span class="line">              ...ruleObj,</span><br><span class="line">              rule: ruleObj,</span><br><span class="line">              value</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">if</span> (message) errors.push(message)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      errors,</span><br><span class="line">      warnings</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行校验</span></span><br><span class="line">  validate (path, options) &#123;</span><br><span class="line">    <span class="keyword">const</span> pattern = FormPath.getPath(path || <span class="string">'*'</span>)</span><br><span class="line">    <span class="keyword">let</span> errors = []</span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">Promise</span>.all(reduce(</span><br><span class="line">        <span class="keyword">this</span>.nodes,</span><br><span class="line">        (buf, validator, path) =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (pattern.match(path)) &#123;</span><br><span class="line">            <span class="keyword">return</span> buf.concat(</span><br><span class="line">              <span class="comment">// validator 为 register</span></span><br><span class="line">              validator(options).then(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (result.errors.length) &#123;</span><br><span class="line">                  errors = errors.concat(&#123;</span><br><span class="line">                    path: path.toString(),</span><br><span class="line">                    messages: result.errors</span><br><span class="line">                  &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;)</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> buf</span><br><span class="line">        &#125;, []</span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      errors,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">test(<span class="string">'all'</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> validator = <span class="keyword">new</span> FormValidator();</span><br><span class="line">  validator.register(<span class="string">'a.b.c.e'</span>, validate =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> validate(<span class="string">''</span>, [</span><br><span class="line">      &#123; <span class="attr">required</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        format: <span class="string">'number'</span>,</span><br><span class="line">        message: <span class="string">'This field is not a number.'</span></span><br><span class="line">      &#125;</span><br><span class="line">    ])</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">const</span> validateResponse = <span class="keyword">await</span> validator.validate()</span><br><span class="line">  expect(validateResponse).toEqual(&#123;</span><br><span class="line">    errors: [&#123; <span class="attr">path</span>: <span class="string">'a.b.c.e'</span>, <span class="attr">messages</span>: [<span class="string">'This field is required'</span>] &#125;],</span><br><span class="line">    warnings: []</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="核心库-formily-core"><a href="#核心库-formily-core" class="headerlink" title="核心库 - @formily/core"></a>核心库 - @formily/core</h2><p>顾名思义，核心库是 Formily 中最关键的部分。</p>
<h3 id="事件系统-FormLifeCycle"><a href="#事件系统-FormLifeCycle" class="headerlink" title="事件系统 - FormLifeCycle"></a>事件系统 - FormLifeCycle</h3><h4 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h4><p>遵循发布-订阅模式的简单事件系统。</p>
<ul>
<li>创建订阅者时，支持三种模式：单个 handler、指定 type 触发的 handler，包含多个{type: handler}的映射表。</li>
<li>发布时，支持指定触发 type、函数实参、函数执行上下文。</li>
</ul>
<h4 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">FormLifeCycle</span>&lt;<span class="title">Payload</span> </span>= any&gt; &#123;</span><br><span class="line">  private listener: FormLifeCyclePayload&lt;Payload&gt;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(handler: FormLifeCycleHandler&lt;Payload&gt;)</span><br><span class="line">  <span class="keyword">constructor</span>(type: string, handler: FormLifeCycleHandler&lt;Payload&gt;)</span><br><span class="line">  <span class="keyword">constructor</span>(handlerMap: &#123; [key: string]: FormLifeCycleHandler&lt;Payload&gt; &#125;)</span><br><span class="line">  <span class="keyword">constructor</span>(...params: any[]) &#123;</span><br><span class="line">    <span class="keyword">this</span>.listener = <span class="keyword">this</span>.buildListener(params)</span><br><span class="line">  &#125;</span><br><span class="line">  buildListener(params: any[]) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">payload: &#123; type: string; payload: Payload &#125;, ctx: any</span>) </span>&#123;</span><br><span class="line">      <span class="comment">//  找到匹配的 type 的 handler，执行 handler</span></span><br><span class="line">      <span class="keyword">if</span> (type === payload.type) &#123;</span><br><span class="line">        handler.call(<span class="keyword">this</span>, payload.payload, ctx)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notify = &lt;Payload&gt;(type: any, payload: Payload, ctx?: any) =&gt; &#123;</span><br><span class="line">    if (isStr(type)) &#123;</span><br><span class="line">      this.listener.call(ctx, &#123; type, payload &#125;, ctx)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="事件系统-FormHeart"><a href="#事件系统-FormHeart" class="headerlink" title="事件系统 - FormHeart"></a>事件系统 - FormHeart</h3><h4 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h4><p>基于 FormLifeCycle 的包装器，主要提供了多个 FormLifeCycle 实例注册、默认 context 、发布事件前的钩子、发布事件后的钩子等配置。且 FormHeart 继承了发布-订阅类 Subscribable，支持在 FormHeart 实例上设置事件订阅器、取消事件订阅器、发布事件。</p>
<h4 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">FormHeart</span>&lt;<span class="title">Payload</span> </span>= any, Context = any&gt; extends Subscribable &#123;</span><br><span class="line">  private lifecycles: FormLifeCycle&lt;Payload&gt;[]</span><br><span class="line">  private context: Context</span><br><span class="line">  private beforeNotify?: <span class="function">(<span class="params">...args: any[]</span>) =&gt;</span> <span class="keyword">void</span></span><br><span class="line">  private afterNotify?: <span class="function">(<span class="params">...args: any[]</span>) =&gt;</span> <span class="keyword">void</span></span><br><span class="line">  <span class="keyword">constructor</span>(&#123;</span><br><span class="line">    lifecycles,</span><br><span class="line">    context,</span><br><span class="line">    beforeNotify,</span><br><span class="line">    afterNotify</span><br><span class="line">  &#125;: &#123;</span><br><span class="line">    lifecycles?: FormLifeCycle[]</span><br><span class="line">    context?: Context</span><br><span class="line">    beforeNotify?: <span class="function">(<span class="params">...args: any[]</span>) =&gt;</span> <span class="keyword">void</span></span><br><span class="line">    afterNotify?: <span class="function">(<span class="params">...args: any[]</span>) =&gt;</span> <span class="keyword">void</span></span><br><span class="line">  &#125; = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">super</span>()</span><br><span class="line">    <span class="keyword">this</span>.lifecycles = <span class="keyword">this</span>.buildLifeCycles(lifecycles || [])</span><br><span class="line">    <span class="keyword">this</span>.context = context</span><br><span class="line">    <span class="keyword">this</span>.beforeNotify = beforeNotify</span><br><span class="line">    <span class="keyword">this</span>.afterNotify = afterNotify</span><br><span class="line">  &#125;</span><br><span class="line">  buildLifeCycles(lifecycles: FormLifeCycle[]) &#123;</span><br><span class="line">   <span class="comment">// 处理 lifecycles 参数，主要是深度遍历后铺平成一位数组，元素为 FormLifeCycle 实例</span></span><br><span class="line">  &#125;</span><br><span class="line">  publish = &lt;P, C&gt;(type: any, payload: P, context?: C) =&gt; &#123;</span><br><span class="line">    if (isStr(type)) &#123;</span><br><span class="line">      // 发布事件前的钩子</span><br><span class="line">      if (isFn(this.beforeNotify)) &#123;</span><br><span class="line">        this.beforeNotify(type, payload, context)</span><br><span class="line">      &#125;</span><br><span class="line">      // 发布事件，依次执行 FormLifeCycle 实例上的 handler</span><br><span class="line">      this.lifecycles.forEach(lifecycle =&gt; &#123;</span><br><span class="line">        lifecycle.notify(type, payload, context || this.context)</span><br><span class="line">      &#125;)</span><br><span class="line">      // 发布事件，执行 FormHeart 实例上的 handler</span><br><span class="line">      this.notify(&#123;</span><br><span class="line">        type,</span><br><span class="line">        payload</span><br><span class="line">      &#125;)</span><br><span class="line">      // 发布事件后的钩子</span><br><span class="line">      if (isFn(this.afterNotify)) &#123;</span><br><span class="line">        this.afterNotify(type, payload, context)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="状态系统-FormGraph"><a href="#状态系统-FormGraph" class="headerlink" title="状态系统 - FormGraph"></a>状态系统 - FormGraph</h3><p>包含了表单状态和表单项状态，以及扁平化存储状态的 Graph。</p>
<h4 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h4><p>表单项状态图。内部主要维护了表单项状态表和父子节点快速索引表，并提供了一系列查询和更新数据的方法。且 FormGraph 继承了发布-订阅类 Subscribable，当 FormGraph 更新时，在更新函数内部自动触发相应类型时间。<br>重要数据：</p>
<ul>
<li>nodes：从表单项路径的维度，<strong>扁平化存储表单及表单项状态</strong>。{[key in string]: NodeType}，其中，key 为 path，value 为对应路径的表单或表单项状态（FormState 、FieldState、VirtualFieldState 的实例）</li>
<li>refrences：从表单项路径的维度，<strong>扁平化存储表单及表单项父子节点的索引信息</strong>。{[key in string]: FormGraphNodeRef}，其中，key 为 path，value 类型为{parent?: FormGraphNodeRef, path: FormPath, children: FormPath[]}。</li>
</ul>
<p>查询类型方法（部分）：</p>
<ul>
<li>get：精确查询指定 path 的数据节点。get(path: FormPathPattern)</li>
<li>select：模糊查询指定 path 的数据节点。select(path: FormPathPattern)</li>
<li>selectParent：精确查询指定 path 的父节点。selectParent(path: FormPathPattern)</li>
<li>selectChildren：精确查询指定 path 的所有孩子节点，基于 DFS。selectChildren(path: FormPathPattern)</li>
<li>getLatestParent：精确查询指定 path 的最近有效父节点。getLatestParent(path: FormPathPattern)</li>
<li>eachChildren：递归遍历所有孩子节点，可以通过参数 recursion 控制是否要深层遍历，默认为 true</li>
</ul>
<p>更新类型方法：</p>
<ul>
<li>appendNode：新增数据节点。appendNode(path: FormPathPattern, node: NodeType)</li>
<li>remove：移除数据节点。remove(path: FormPathPattern)</li>
<li>replace：替换数据节点。replace(path: FormPathPattern, node: NodeType)</li>
</ul>
<h4 id="源码分析-3"><a href="#源码分析-3" class="headerlink" title="源码分析"></a>源码分析</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">FormGraph</span>&lt;<span class="title">NodeType</span> </span>= any&gt; extends Subscribable &#123;</span><br><span class="line">  private refrences: &#123;</span><br><span class="line">    [key <span class="keyword">in</span> string]: FormGraphNodeRef</span><br><span class="line">  &#125;</span><br><span class="line">  private nodes: &#123;</span><br><span class="line">    [key <span class="keyword">in</span> string]: NodeType</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">constructor</span>(props: FormGraphProps = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">super</span>()</span><br><span class="line">    <span class="keyword">this</span>.refrences = &#123;&#125;</span><br><span class="line">    <span class="keyword">this</span>.nodes = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模糊查询指定 path 的数据节点</span></span><br><span class="line">  select(path: FormPathPattern) &#123;</span><br><span class="line">    <span class="keyword">const</span> pattern = FormPath.parse(path)</span><br><span class="line">    <span class="keyword">const</span> node = <span class="keyword">this</span>.get(pattern)</span><br><span class="line">      <span class="keyword">if</span> (node) &#123;</span><br><span class="line">        <span class="keyword">return</span> node</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> nodePath <span class="keyword">in</span> <span class="keyword">this</span>.nodes) &#123;</span><br><span class="line">      <span class="keyword">const</span> node = <span class="keyword">this</span>.nodes[nodePath]</span><br><span class="line">      <span class="keyword">if</span> (pattern.match(nodePath)) &#123;</span><br><span class="line">        <span class="keyword">return</span> node</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 精确查询指定 path 的数据节点</span></span><br><span class="line">  <span class="keyword">get</span>(path: FormPathPattern) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.nodes[FormPath.parse(path).toString()]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 精确查询指定 path 的父节点</span></span><br><span class="line">  selectParent(path: FormPathPattern) &#123;</span><br><span class="line">    <span class="keyword">const</span> selfPath = FormPath.parse(path)</span><br><span class="line">    <span class="keyword">const</span> parentPath = FormPath.parse(path).parent()</span><br><span class="line">    <span class="keyword">if</span> (selfPath.toString() === parentPath.toString()) <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.get(parentPath)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 精确查询指定 path 的所有孩子节点，基于 DFS</span></span><br><span class="line">  selectChildren(path: FormPathPattern) &#123;</span><br><span class="line">    <span class="keyword">const</span> ref = <span class="keyword">this</span>.refrences[FormPath.parse(path).toString()]</span><br><span class="line">    <span class="keyword">if</span> (ref &amp;&amp; ref.children) &#123;</span><br><span class="line">      <span class="keyword">return</span> reduce(</span><br><span class="line">        ref.children,</span><br><span class="line">        (buf, path) =&gt; &#123;</span><br><span class="line">          <span class="keyword">return</span> buf.concat(<span class="keyword">this</span>.get(path)).concat(<span class="keyword">this</span>.selectChildren(path))</span><br><span class="line">        &#125;,</span><br><span class="line">        []</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 精确查询指定 path 的最近有效父节点</span></span><br><span class="line">  getLatestParent(path: FormPathPattern) &#123;</span><br><span class="line">    <span class="keyword">const</span> selfPath = FormPath.parse(path)</span><br><span class="line">    <span class="keyword">const</span> parentPath = FormPath.parse(path).parent()</span><br><span class="line">    <span class="keyword">if</span> (selfPath.toString() === parentPath.toString()) <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.refrences[parentPath.toString()])</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ref: <span class="keyword">this</span>.refrences[parentPath.toString()],</span><br><span class="line">        path: FormPath.parse(parentPath.toString())</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getLatestParent(parentPath)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递归遍历所有孩子节点，可以通过参数 recursion 控制是否要深层遍历</span></span><br><span class="line">  eachChildren(eacher: FormGraphEacher&lt;NodeType&gt;, recursion?: boolean): <span class="keyword">void</span></span><br><span class="line">  eachChildren(</span><br><span class="line">    path: FormPathPattern,</span><br><span class="line">    eacher: FormGraphEacher&lt;NodeType&gt;,</span><br><span class="line">    recursion?: boolean</span><br><span class="line">  ): <span class="keyword">void</span></span><br><span class="line">  eachChildren(</span><br><span class="line">    path: FormPathPattern,</span><br><span class="line">    selector: FormPathPattern,</span><br><span class="line">    eacher: FormGraphEacher&lt;NodeType&gt;,</span><br><span class="line">    recursion?: boolean</span><br><span class="line">  ): <span class="keyword">void</span></span><br><span class="line">  eachChildren(</span><br><span class="line">    path: any,</span><br><span class="line">    selector: any = <span class="literal">true</span>,</span><br><span class="line">    eacher: any = <span class="literal">true</span>,</span><br><span class="line">    recursion: any = <span class="literal">true</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isFn(path)) &#123;</span><br><span class="line">      recursion = selector</span><br><span class="line">      eacher = path</span><br><span class="line">      path = <span class="string">''</span></span><br><span class="line">      selector = <span class="string">'*'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isFn(selector)) &#123;</span><br><span class="line">      recursion = eacher</span><br><span class="line">      eacher = selector</span><br><span class="line">      selector = <span class="string">'*'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> ref = <span class="keyword">this</span>.refrences[FormPath.parse(path).toString()]</span><br><span class="line">    <span class="keyword">if</span> (ref &amp;&amp; ref.children) &#123;</span><br><span class="line">      <span class="keyword">return</span> each(ref.children, path =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (isFn(eacher)) &#123;</span><br><span class="line">          <span class="keyword">const</span> node = <span class="keyword">this</span>.get(path)</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            node &amp;&amp;</span><br><span class="line">            (isFn(<span class="keyword">this</span>.matchStrategy)</span><br><span class="line">              ? <span class="keyword">this</span>.matchStrategy(selector, path)</span><br><span class="line">              : FormPath.parse(selector).match(path))</span><br><span class="line">          ) &#123;</span><br><span class="line">            eacher(node, path)</span><br><span class="line">            <span class="keyword">if</span> (recursion) &#123;</span><br><span class="line">              <span class="keyword">this</span>.eachChildren(path, selector, eacher, recursion)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 新增指定 path 的数据节点</span></span><br><span class="line">  appendNode(path: FormPathPattern, <span class="attr">node</span>: NodeType) &#123;</span><br><span class="line">    <span class="keyword">const</span> selfPath = FormPath.parse(path)</span><br><span class="line">    <span class="keyword">const</span> parentPath = selfPath.parent()</span><br><span class="line">    <span class="keyword">const</span> parentRef = <span class="keyword">this</span>.refrences[parentPath.toString()]</span><br><span class="line">    <span class="keyword">const</span> selfRef: FormGraphNodeRef = &#123;</span><br><span class="line">      path: selfPath,</span><br><span class="line">      children: []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.get(selfPath)) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">this</span>.nodes[selfPath.toString()] = node</span><br><span class="line">    <span class="keyword">this</span>.refrences[selfPath.toString()] = selfRef</span><br><span class="line">    <span class="keyword">if</span> (parentRef) &#123;</span><br><span class="line">      parentRef.children.push(selfPath)</span><br><span class="line">      selfRef.parent = parentRef</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> latestParent = <span class="keyword">this</span>.getLatestParent(selfPath)</span><br><span class="line">      <span class="keyword">if</span> (latestParent) &#123;</span><br><span class="line">        latestParent.ref.children.push(selfPath)</span><br><span class="line">        selfRef.parent = latestParent.ref</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.notify(&#123;</span><br><span class="line">      type: <span class="string">'GRAPH_NODE_DID_MOUNT'</span>,</span><br><span class="line">      payload: selfRef</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除节点</span></span><br><span class="line">  remove(path: FormPathPattern) &#123;</span><br><span class="line">    <span class="keyword">const</span> selfPath = FormPath.parse(path)</span><br><span class="line">    <span class="keyword">const</span> selfRef = <span class="keyword">this</span>.refrences[selfPath.toString()]</span><br><span class="line">    <span class="keyword">if</span> (!selfRef) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">this</span>.notify(&#123;</span><br><span class="line">      type: <span class="string">'GRAPH_NODE_WILL_UNMOUNT'</span>,</span><br><span class="line">      payload: selfRef</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (selfRef.children) &#123;</span><br><span class="line">      selfRef.children.forEach(<span class="function"><span class="params">path</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.remove(path)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>.nodes[selfPath.toString()]</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>.refrences[selfPath.toString()]</span><br><span class="line">    <span class="keyword">if</span> (selfRef.parent) &#123;</span><br><span class="line">      selfRef.parent.children.forEach(<span class="function">(<span class="params">path, index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (path.match(selfPath)) &#123;</span><br><span class="line">          selfRef.parent.children.splice(index, <span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 替换节点</span></span><br><span class="line">  replace(path: FormPathPattern, <span class="attr">node</span>: NodeType) &#123;</span><br><span class="line">    <span class="keyword">const</span> selfPath = FormPath.parse(path)</span><br><span class="line">    <span class="keyword">const</span> selfRef = <span class="keyword">this</span>.refrences[selfPath.toString()]</span><br><span class="line">    <span class="keyword">if</span> (!selfRef) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">this</span>.notify(&#123;</span><br><span class="line">      type: <span class="string">'GRAPH_NODE_WILL_UNMOUNT'</span>,</span><br><span class="line">      payload: selfRef</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">this</span>.nodes[selfPath.toString()] = node</span><br><span class="line">    <span class="keyword">this</span>.notify(&#123;</span><br><span class="line">      type: <span class="string">'GRAPH_NODE_DID_MOUNT'</span>,</span><br><span class="line">      payload: selfRef</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="状态系统-FormState、FieldState、VirtualFieldState"><a href="#状态系统-FormState、FieldState、VirtualFieldState" class="headerlink" title="状态系统 - FormState、FieldState、VirtualFieldState"></a>状态系统 - FormState、FieldState、VirtualFieldState</h3><h4 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h4><p>表单状态、表单项状态、虚拟表单项状态</p>
<h4 id="源码分析-4"><a href="#源码分析-4" class="headerlink" title="源码分析"></a>源码分析</h4><p><strong>公用函数 createStateModel</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Immer &#125; <span class="keyword">from</span> <span class="string">'immer'</span></span><br><span class="line"><span class="keyword">const</span> &#123; produce &#125; = <span class="keyword">new</span> Immer(&#123;</span><br><span class="line">  autoFreeze: <span class="literal">false</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 符合抽象工厂模式，生成状态类的公用函数，适用于表单状态、表单项状态及虚拟表单项状态。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createStateModel = &lt;State = &#123;&#125;, Props = &#123;&#125;&gt;(</span><br><span class="line">  Factory: IStateModelFactory&lt;State, Props&gt;</span><br><span class="line">): IStateModelProvider&lt;State, Props&gt; =&gt; &#123;</span><br><span class="line">  return class Model&lt;DefaultProps = any&gt; extends Subscribable&lt;State&gt;</span><br><span class="line">    implements IModel&lt;State, Props &amp; DefaultProps&gt; &#123;</span><br><span class="line">    public state: State &amp; &#123; displayName?: string &#125;</span><br><span class="line">    public props: Props &amp;</span><br><span class="line">      DefaultProps &amp; &#123;</span><br><span class="line">        useDirty?: boolean</span><br><span class="line">        computeState?: (draft: State, prevState: State) =&gt; void</span><br><span class="line">      &#125;</span><br><span class="line">    public cache?: any</span><br><span class="line">    public displayName?: string</span><br><span class="line">    public dirtyNum: number</span><br><span class="line">    public dirtys: StateDirtyMap&lt;State&gt;</span><br><span class="line">    public prevState: State</span><br><span class="line">    public batching: boolean</span><br><span class="line">    public stackCount: number</span><br><span class="line">    public controller: StateModel&lt;State&gt;</span><br><span class="line">    constructor(defaultProps: DefaultProps) &#123;</span><br><span class="line">      super()</span><br><span class="line">      this.state = &#123; ...Factory.defaultState &#125; // 记录状态</span><br><span class="line">      this.prevState = this.state              // 记录上次的状态，用于判断是否有更新</span><br><span class="line">      this.props = defaults(Factory.defaultProps, defaultProps)</span><br><span class="line">      this.dirtys = &#123;&#125;                         // 记录脏数据</span><br><span class="line">      this.cache = &#123;&#125;</span><br><span class="line">      this.dirtyNum = 0</span><br><span class="line">      this.stackCount = 0</span><br><span class="line">      this.batching = false</span><br><span class="line">      this.controller = new Factory(this.state, this.props)</span><br><span class="line">      this.displayName = Factory.displayName</span><br><span class="line">      this.state.displayName = this.displayName</span><br><span class="line">    &#125;</span><br><span class="line">    // 在 callback 中可批量处理多个状态更新</span><br><span class="line">    batch = (callback?: () =&gt; void) =&gt; &#123;</span><br><span class="line">      this.batching = true</span><br><span class="line">      if (isFn(callback)) &#123;</span><br><span class="line">        callback()</span><br><span class="line">      &#125;</span><br><span class="line">      if (this.dirtyNum &gt; 0) &#123; //callback 执行完后若存在脏数据，则触发 notify</span><br><span class="line">        this.notify(this.getState())</span><br><span class="line">      &#125;</span><br><span class="line">      this.dirtys = &#123;&#125; // 执行 notify 后，会触发对 dirtys 的一次消费，所以重置</span><br><span class="line">      this.dirtyNum = 0</span><br><span class="line">      this.batching = false</span><br><span class="line">    &#125;</span><br><span class="line">    // 获取实例的 state 属性持久化处理的结果</span><br><span class="line">    getState = (callback?: (state: State) =&gt; any) =&gt; &#123;</span><br><span class="line">      if (isFn(callback)) &#123;</span><br><span class="line">        return callback(this.getState())</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        if (isFn(this.controller.publishState)) &#123;</span><br><span class="line">          return this.controller.publishState(this.state)</span><br><span class="line">        &#125;</span><br><span class="line">        if (!hasProxy || this.props.useDirty) &#123;</span><br><span class="line">          return clone(this.state)             // 返回 state 的深拷贝</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          return produce(this.state, () =&gt; &#123;&#125;) // 返回经过 Immer produce 的 state</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 获取实例的 state 属性</span><br><span class="line">    getSourceState = (callback?: (state: State) =&gt; any) =&gt; &#123;</span><br><span class="line">      if (isFn(callback)) &#123;</span><br><span class="line">        return callback(this.state)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        return this.state</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 更新实例的 state 属性</span><br><span class="line">    setSourceState = (callback: (state: State) =&gt; void) =&gt; &#123;</span><br><span class="line">      if (isFn(callback)) &#123;</span><br><span class="line">        callback(this.state)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    setState = (</span><br><span class="line">      callback: (state: State | Draft&lt;State&gt;) =&gt; State | void,</span><br><span class="line">      silent = false</span><br><span class="line">    ) =&gt; &#123;</span><br><span class="line">      if (isFn(callback)) &#123;</span><br><span class="line">        this.stackCount++</span><br><span class="line">        if (!hasProxy || this.props.useDirty) &#123; // 手动逐个检测更新 state 属性</span><br><span class="line">          const draft = this.getState()</span><br><span class="line">          if (!this.batching) &#123;</span><br><span class="line">            this.dirtys = &#123;&#125;</span><br><span class="line">            this.dirtyNum = 0</span><br><span class="line">          &#125;</span><br><span class="line">          callback(draft)</span><br><span class="line">          if (isFn(this.props.computeState)) &#123;</span><br><span class="line">            this.props.computeState(draft, this.state)</span><br><span class="line">          &#125;</span><br><span class="line">          if (isFn(this.controller.computeState)) &#123;</span><br><span class="line">            this.controller.computeState(draft, this.state)</span><br><span class="line">          &#125;</span><br><span class="line">          const draftKeys = Object.keys(draft || &#123;&#125;)</span><br><span class="line">          const stateKeys = Object.keys(this.state || &#123;&#125;)</span><br><span class="line">          // 逐个赋值更新 state 属性</span><br><span class="line">          each(</span><br><span class="line">            draftKeys.length &gt; stateKeys.length ? draft : this.state,</span><br><span class="line">            (value, key) =&gt; &#123;</span><br><span class="line">              if (!isEqual(this.state[key], draft[key])) &#123;</span><br><span class="line">                this.state[key] = draft[key]</span><br><span class="line">                this.dirtys[key] = true // 标记脏数据</span><br><span class="line">                this.dirtyNum++</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          )</span><br><span class="line">          if (this.dirtyNum &gt; 0 &amp;&amp; !silent) &#123;</span><br><span class="line">            if (this.batching) &#123;</span><br><span class="line">              this.stackCount--</span><br><span class="line">              return</span><br><span class="line">            &#125;</span><br><span class="line">            this.notify(this.getState())</span><br><span class="line">            this.dirtys = &#123;&#125;</span><br><span class="line">            this.dirtyNum = 0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; else &#123; // 借助 Immer produce 的能力解决数据更新的问题</span><br><span class="line">          if (!this.batching) &#123;</span><br><span class="line">            this.dirtys = &#123;&#125; // 批量处理过程中需要保存脏数据状态</span><br><span class="line">            this.dirtyNum = 0</span><br><span class="line">          &#125;</span><br><span class="line">          //用proxy解决脏检查计算属性问题</span><br><span class="line">          this.state = produce(</span><br><span class="line">            this.state,</span><br><span class="line">            draft =&gt; &#123;</span><br><span class="line">              callback(draft)</span><br><span class="line">              if (isFn(this.props.computeState)) &#123;</span><br><span class="line">                this.props.computeState(draft, this.state)</span><br><span class="line">              &#125;</span><br><span class="line">              if (isFn(this.controller.computeState)) &#123;</span><br><span class="line">                this.controller.computeState(draft, this.state)</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            patches =&gt; &#123;</span><br><span class="line">              patches.forEach((&#123; path, op, value &#125;) =&gt; &#123;</span><br><span class="line">                if (op === 'replace') &#123;</span><br><span class="line">                  if (path.length &gt; 1 || !isEqual(this.state[path[0]], value)) &#123;</span><br><span class="line">                    this.dirtys[path[0]] = true // 标记脏数据</span><br><span class="line">                    this.dirtyNum++</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                  this.dirtys[path[0]] = true   // 标记脏数据</span><br><span class="line">                  this.dirtyNum++</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">          )</span><br><span class="line">          if (this.dirtyNum &gt; 0 &amp;&amp; !silent) &#123;</span><br><span class="line">            if (this.batching) &#123;</span><br><span class="line">              this.stackCount--</span><br><span class="line">              return</span><br><span class="line">            &#125;</span><br><span class="line">            this.notify(this.getState())</span><br><span class="line">            this.dirtys = &#123;&#125; // 执行 notify 后，会触发对 dirtys 的一次消费，所以重置</span><br><span class="line">            this.dirtyNum = 0</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        this.stackCount--</span><br><span class="line">        if (!this.stackCount) &#123;</span><br><span class="line">          this.prevState = this.state // state 更新队列清空后，更新 prevState</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // 当前操作的变化情况</span><br><span class="line">    isDirty = (key?: string) =&gt;</span><br><span class="line">      key ? this.dirtys[key] === true : this.dirtyNum &gt; 0</span><br><span class="line">    getDirtyInfo = () =&gt; this.dirtys</span><br><span class="line">    // 在一组操作过程中的变化情况</span><br><span class="line">    hasChanged = (path?: FormPathPattern) =&gt; &#123;</span><br><span class="line">      return path</span><br><span class="line">        ? !isEqual(</span><br><span class="line">            FormPath.getIn(this.prevState, path),</span><br><span class="line">            FormPath.getIn(this.state, path)</span><br><span class="line">          )</span><br><span class="line">        : !isEqual(this.prevState, this.state)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; as any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>FormState</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 核心数据结构，描述 Form 级别状态。主要逻辑都在 createStateModel 方法中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> FormState = createStateModel&lt;IFormState, IFormStateProps&gt;(</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">FormState</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> displayName = <span class="string">'FormState'</span></span><br><span class="line">    <span class="keyword">static</span> defaultState = &#123;</span><br><span class="line">      valid: <span class="literal">true</span>,        <span class="comment">//是否处于合法态，只要errors长度大于0的时候valid为false</span></span><br><span class="line">      invalid: <span class="literal">false</span>,     <span class="comment">//是否处于非法态，只要errors长度大于0的时候valid为true</span></span><br><span class="line">      loading: <span class="literal">false</span>,     <span class="comment">// 是否处于loading状态，注意：如果字段处于异步校验时，loading为true</span></span><br><span class="line">      validating: <span class="literal">false</span>,  <span class="comment">// 是否处于校验态</span></span><br><span class="line">      initialized: <span class="literal">false</span>, <span class="comment">// 是否已经初始化</span></span><br><span class="line">      submitting: <span class="literal">false</span>,</span><br><span class="line">      editable: <span class="literal">true</span>,     <span class="comment">// 是否可编辑</span></span><br><span class="line">      modified: <span class="literal">false</span>,    <span class="comment">// 是否被修改，如果值发生变化，该属性为true，同时在整个字段的生命周期内都会为true</span></span><br><span class="line">      errors: [],         <span class="comment">// 字段错误消息</span></span><br><span class="line">      warnings: [],       <span class="comment">// 字段告警消息</span></span><br><span class="line">      values: &#123;&#125;,         <span class="comment">// 表单数据</span></span><br><span class="line">      initialValues: &#123;&#125;,  <span class="comment">// 表单数据初始值</span></span><br><span class="line">      mounted: <span class="literal">false</span>,     <span class="comment">// 是否挂载</span></span><br><span class="line">      unmounted: <span class="literal">false</span>,   <span class="comment">// 是否卸载</span></span><br><span class="line">      props: &#123;&#125;           <span class="comment">// 字段扩展属性</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> defaultProps = &#123;</span><br><span class="line">      lifecycles: []</span><br><span class="line">    &#125;</span><br><span class="line">    private state: IFormState</span><br><span class="line">    <span class="keyword">constructor</span>(state: IFormState, props: IFormStateProps) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = state</span><br><span class="line">      <span class="keyword">this</span>.state.initialValues = clone(props.initialValues || &#123;&#125;)</span><br><span class="line">      <span class="keyword">this</span>.state.values = clone(props.values || props.initialValues || &#123;&#125;)</span><br><span class="line">      <span class="keyword">this</span>.state.editable = props.editable</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在调用 FormState 实例的 setState 方法时，作为 controller.computeState 执行</span></span><br><span class="line">    computeState(draft: IFormState, <span class="attr">prevState</span>: IFormState) &#123;</span><br><span class="line">      <span class="comment">// ...省略根据数据，计算 invalid、valid、modified、loading、unmounted、mounted 、props 并更新</span></span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>FieldState</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 核心数据结构，描述表单字段的所有状态。主要逻辑都在 createStateModel 方法中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> FieldState = createStateModel&lt;IFieldState, IFieldStateProps&gt;(</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">FieldState</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> displayName = <span class="string">'FieldState'</span></span><br><span class="line">    <span class="keyword">static</span> defaultState = &#123;</span><br><span class="line">      name: <span class="string">''</span>,                 <span class="comment">// 数据路径</span></span><br><span class="line">      path: <span class="string">''</span>,                 <span class="comment">// 节点路径</span></span><br><span class="line">      dataType: <span class="string">'any'</span>,          <span class="comment">// 数据类型</span></span><br><span class="line">      initialized: <span class="literal">false</span>,       <span class="comment">// 是否已经初始化</span></span><br><span class="line">      invalid: <span class="literal">false</span>,           <span class="comment">// 是否处于非法态，只要errors长度大于0的时候valid为true</span></span><br><span class="line">      pristine: <span class="literal">true</span>,           <span class="comment">// 是否处于原始态，只有value===intialValues时的时候该状态为true</span></span><br><span class="line">      valid: <span class="literal">true</span>,              <span class="comment">// 是否处于合法态，只要errors长度大于0的时候valid为false</span></span><br><span class="line">      modified: <span class="literal">false</span>,          <span class="comment">// 是否被修改，如果值发生变化，该属性为true，同时在整个字段的生命周期内都会为true</span></span><br><span class="line">      touched: <span class="literal">false</span>,           <span class="comment">// 是否被触碰</span></span><br><span class="line">      active: <span class="literal">false</span>,            <span class="comment">// 是否被激活，字段触发onFocus事件的时候，它会被触发为true，触发onBlur时，为false</span></span><br><span class="line">      visited: <span class="literal">false</span>,           <span class="comment">// 是否访问过，字段触发onBlur事件的时候，它会被触发为true</span></span><br><span class="line">      visible: <span class="literal">true</span>,            <span class="comment">// 是否可见，注意：该状态如果为false，那么字段的值不会被提交，同时UI不会显示</span></span><br><span class="line">      display: <span class="literal">true</span>,            <span class="comment">// 是否展示，注意：该状态如果为false，那么字段的值会提交，UI不会展示，类似于表单隐藏域</span></span><br><span class="line">      loading: <span class="literal">false</span>,           <span class="comment">// 是否处于loading状态，注意：如果字段处于异步校验时，loading为true</span></span><br><span class="line">      validating: <span class="literal">false</span>,        <span class="comment">// 是否处于校验态</span></span><br><span class="line">      warnings: [],             <span class="comment">// 字段告警消息</span></span><br><span class="line">      errors: [],               <span class="comment">// 字段错误消息</span></span><br><span class="line">      value: <span class="literal">undefined</span>,         <span class="comment">// 字段值，与values[0]是恒定相等</span></span><br><span class="line">      values: [],               <span class="comment">// 字段多参值，比如字段onChange触发时，给事件回调传了多参数据，那么这里会存储所有参数的值</span></span><br><span class="line">      editable: <span class="literal">true</span>,           <span class="comment">// 是否可编辑</span></span><br><span class="line">      initialValue: <span class="literal">undefined</span>,  <span class="comment">// 初始值</span></span><br><span class="line">      rules: [],                <span class="comment">// 校验规则</span></span><br><span class="line">      required: <span class="literal">false</span>,          <span class="comment">// 是否必填，为 true 会同时设置校验规则  s</span></span><br><span class="line">      mounted: <span class="literal">false</span>,           <span class="comment">// 是否挂载</span></span><br><span class="line">      unmounted: <span class="literal">false</span>,         <span class="comment">// 是否卸载</span></span><br><span class="line">      unmountRemoveValue: <span class="literal">true</span>, <span class="comment">// 是否在卸载时自动删除字段值</span></span><br><span class="line">      props: &#123;&#125;                 <span class="comment">// 字段扩展属性</span></span><br><span class="line">      <span class="comment">// ...省略其他可忽略属性</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> defaultProps = &#123;</span><br><span class="line">      path: <span class="string">''</span>,</span><br><span class="line">      dataType: <span class="string">'any'</span></span><br><span class="line">    &#125;</span><br><span class="line">    private state: IFieldState</span><br><span class="line">    private nodePath: FormPath</span><br><span class="line">    private dataPath: FormPath</span><br><span class="line">    <span class="keyword">constructor</span>(state: IFieldState, props: IFieldStateProps) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = state</span><br><span class="line">      <span class="keyword">this</span>.nodePath = FormPath.getPath(props.nodePath)</span><br><span class="line">      <span class="keyword">this</span>.dataPath = FormPath.getPath(props.dataPath)</span><br><span class="line">      <span class="keyword">this</span>.state.name = <span class="keyword">this</span>.dataPath.entire</span><br><span class="line">      <span class="keyword">this</span>.state.path = <span class="keyword">this</span>.nodePath.entire</span><br><span class="line">      <span class="keyword">this</span>.state.dataType = props.dataType || <span class="string">'any'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在调用 FieldState 实例的 setState 方法时，作为 controller.computeState 执行</span></span><br><span class="line">    computeState(draft: IFieldState, <span class="attr">prevState</span>: IFieldState) &#123;</span><br><span class="line">      <span class="comment">// ...省略根据数据，计算 invalid、valid、modified、loading、unmounted、mounted、props、rules、required、errors、warnings、editable、pristine 并更新</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>VirtualFieldState</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Formily特有，描述一个虚拟字段，</span></span><br><span class="line"><span class="comment"> * 它不占用数据空间，但是它拥有状态，</span></span><br><span class="line"><span class="comment"> * 可以联动控制Field或者VirtualField的状态</span></span><br><span class="line"><span class="comment"> * 类似于现在Formily的Card之类的容器布局组件</span></span><br><span class="line"><span class="comment"> * 主要逻辑都在 createStateModel 方法中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> VirtualFieldState = createStateModel&lt;</span><br><span class="line">  IVirtualFieldState,</span><br><span class="line">  IVirtualFieldStateProps</span><br><span class="line">&gt;(</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">VirtualFieldState</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> displayName = <span class="string">'VirtualFieldState'</span></span><br><span class="line">    <span class="keyword">static</span> defaultState = &#123;</span><br><span class="line">      name: <span class="string">''</span>,</span><br><span class="line">      path: <span class="string">''</span>,</span><br><span class="line">      initialized: <span class="literal">false</span>,</span><br><span class="line">      visible: <span class="literal">true</span>,</span><br><span class="line">      display: <span class="literal">true</span>,</span><br><span class="line">      mounted: <span class="literal">false</span>,</span><br><span class="line">      unmounted: <span class="literal">false</span>,</span><br><span class="line">      props: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> defaultProps = &#123;</span><br><span class="line">      path: <span class="string">''</span>,</span><br><span class="line">      props: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private state: IVirtualFieldState</span><br><span class="line">    private path: FormPath</span><br><span class="line">    private dataPath: FormPath</span><br><span class="line">    <span class="keyword">constructor</span>(state: IVirtualFieldState, props: IVirtualFieldStateProps) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = state</span><br><span class="line">      <span class="keyword">this</span>.path = FormPath.getPath(props.nodePath)</span><br><span class="line">      <span class="keyword">this</span>.dataPath = FormPath.getPath(props.dataPath)</span><br><span class="line">      <span class="keyword">this</span>.state.path = <span class="keyword">this</span>.path.entire</span><br><span class="line">      <span class="keyword">this</span>.state.name = <span class="keyword">this</span>.dataPath.entire</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在调用 VirtualFieldState 实例的 setState 方法时，作为 controller.computeState 执行</span></span><br><span class="line">    computeState(draft: IVirtualFieldState, <span class="attr">prevState</span>: IVirtualFieldState) &#123;</span><br><span class="line">      <span class="comment">// ...省略根据数据，计算 unmounted、mounted、props 并更新</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="表单-API-创建表单实例"><a href="#表单-API-创建表单实例" class="headerlink" title="表单 API - 创建表单实例"></a>表单 API - 创建表单实例</h3><p>整个核心库向外导出的 API，将路径系统、校验系统、事件系统、状态系统等都连接起来，构成完整的表单体系。</p>
<h4 id="概述-5"><a href="#概述-5" class="headerlink" title="概述"></a>概述</h4><p>创建 Form 实例，做好准备工作。</p>
<h4 id="源码分析-5"><a href="#源码分析-5" class="headerlink" title="源码分析"></a>源码分析</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> interface IFormStateProps &#123;</span><br><span class="line">  initialValues?: &#123;&#125;           <span class="comment">// 表单初始值</span></span><br><span class="line">  values?: &#123;&#125;                  <span class="comment">// 表单值</span></span><br><span class="line">  lifecycles?: FormLifeCycle[] <span class="comment">// 生命周期监听器，在这里主要传入FormLifeCycle的实例化对象</span></span><br><span class="line">  useDirty?: boolean           <span class="comment">// 是否使用脏检查，默认会走immer精确更新</span></span><br><span class="line">  editable?: boolean | <span class="function">(<span class="params">(name: string</span>) =&gt;</span> boolean) <span class="comment">// 是否可编辑</span></span><br><span class="line">  validateFirst?: boolean      <span class="comment">//是否走悲观校验，遇到第一个校验失败就停止后续校验</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface IFormCreatorOptions extends IFormStateProps &#123;</span><br><span class="line">  onChange?: <span class="function">(<span class="params">values: IFormState[<span class="string">'values'</span>]</span>) =&gt;</span> <span class="keyword">void</span></span><br><span class="line">  onSubmit?: <span class="function">(<span class="params">values: IFormState[<span class="string">'values'</span>]</span>) =&gt;</span> any | <span class="built_in">Promise</span>&lt;any&gt;</span><br><span class="line">  onReset?: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span></span><br><span class="line">  onValidateFailed?: <span class="function">(<span class="params">validated: IFormValidateResult</span>) =&gt;</span> <span class="keyword">void</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createForm</span>(<span class="params">options: IFormCreatorOptions = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onFormChange</span>(<span class="params">published: IFormState</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...暂时省略，在"监听表单更新"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onFieldChange</span>(<span class="params">&#123; field, path &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...暂时省略，在"监听表单更新"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onVirtualFieldChange</span>(<span class="params">&#123; field, path &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...暂时省略，在"监听表单更新"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onGraphChange</span>(<span class="params">&#123; type, payload &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...暂时省略，在"监听表单更新"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">registerField</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    path,</span></span></span><br><span class="line"><span class="function"><span class="params">    name,</span></span></span><br><span class="line"><span class="function"><span class="params">    value,</span></span></span><br><span class="line"><span class="function"><span class="params">    initialValue,</span></span></span><br><span class="line"><span class="function"><span class="params">    required,</span></span></span><br><span class="line"><span class="function"><span class="params">    rules,</span></span></span><br><span class="line"><span class="function"><span class="params">    editable,</span></span></span><br><span class="line"><span class="function"><span class="params">    visible,</span></span></span><br><span class="line"><span class="function"><span class="params">    display,</span></span></span><br><span class="line"><span class="function"><span class="params">    computeState,</span></span></span><br><span class="line"><span class="function"><span class="params">    dataType,</span></span></span><br><span class="line"><span class="function"><span class="params">    useDirty,</span></span></span><br><span class="line"><span class="function"><span class="params">    unmountRemoveValue,</span></span></span><br><span class="line"><span class="function"><span class="params">    props</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;: Exclude&lt;IFieldStateProps, <span class="string">'dataPath'</span> | <span class="string">'nodePath'</span>&gt;</span>): <span class="title">IField</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...暂时省略，在"注册表单项"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">registerVirtualField</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    name,</span></span></span><br><span class="line"><span class="function"><span class="params">    path,</span></span></span><br><span class="line"><span class="function"><span class="params">    props,</span></span></span><br><span class="line"><span class="function"><span class="params">    display,</span></span></span><br><span class="line"><span class="function"><span class="params">    visible,</span></span></span><br><span class="line"><span class="function"><span class="params">    computeState,</span></span></span><br><span class="line"><span class="function"><span class="params">    useDirty</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;: IVirtualFieldStateProps</span>): <span class="title">IVirtualField</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...暂时省略，在"注册表单项"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getFormState</span>(<span class="params">callback?: (state: IFormState</span>) =&gt; <span class="title">any</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...暂时省略，在"读写表单状态"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setFormState</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    callback?: (state: IFormState</span>) =&gt; <span class="title">any</span>,</span></span><br><span class="line"><span class="function">    <span class="title">silent</span>?: <span class="title">boolean</span></span></span><br><span class="line"><span class="function">  ) </span>&#123;   <span class="comment">// ...暂时省略，在"读写表单状态"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getFieldState</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    path: FormPathPattern,</span></span></span><br><span class="line"><span class="function"><span class="params">    callback?: (state: IFieldState&lt;FormilyCore.FieldProps&gt;</span>) =&gt; <span class="title">any</span></span></span><br><span class="line"><span class="function">  ) </span>&#123;    <span class="comment">// ...暂时省略，在"读写表单状态"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setFieldState</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    path: FormPathPattern,</span></span></span><br><span class="line"><span class="function"><span class="params">    callback?: (state: IFieldState&lt;FormilyCore.FieldProps&gt;</span>) =&gt; <span class="title">void</span>,</span></span><br><span class="line"><span class="function">    <span class="title">silent</span>?: <span class="title">boolean</span></span></span><br><span class="line"><span class="function">  ) </span>&#123;</span><br><span class="line">    <span class="comment">// ...暂时省略，在"读写表单状态"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getFormGraph</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...暂时省略，在"读写表单状态"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setFormGraph</span>(<span class="params">nodes: &#123;&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...暂时省略，在"读写表单状态"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    path?: FormPathPattern,</span></span></span><br><span class="line"><span class="function"><span class="params">    opts?: IFormExtendedValidateFieldOptions</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Promise</span>&lt;<span class="title">IFormValidateResult</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ...暂时省略，在"表单校验和提交"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">submit</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    onSubmit?: (values: IFormState[<span class="string">'values'</span>]</span>) =&gt; <span class="title">any</span> | <span class="title">Promise</span>&lt;<span class="title">any</span>&gt;</span></span><br><span class="line"><span class="function">  ): <span class="title">Promise</span>&lt;<span class="title">IFormSubmitResult</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ...暂时省略，在"表单校验和提交"中详细介绍</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 定义表单项路径匹配策略，返回值为 boolean。true 为匹配，false 为不匹配</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">matchStrategy</span>(<span class="params">pattern: FormPathPattern, nodePath: FormPathPattern</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> matchPattern = FormPath.parse(pattern)</span><br><span class="line">    <span class="keyword">const</span> node = graph.get(nodePath) <span class="comment">// 根据 nodePath 从 FormGraph 实例中取出 node</span></span><br><span class="line">    <span class="keyword">if</span> (!node) <span class="keyword">return</span> <span class="literal">false</span>          <span class="comment">// 异常情况：未找到匹配的 node，返回 false</span></span><br><span class="line">    <span class="keyword">return</span> node.getSourceState(<span class="function"><span class="params">state</span> =&gt;</span></span><br><span class="line">      <span class="comment">// 别名组匹配，path 属性作为别名，由于 VirtualFieldState 的存在，path 与 name 不恒等。在匹配路径时，一般匹配规则下，name 和 path 匹配一个即可。特殊的，面对"非"匹配规则，取 name 和 path 匹配程度更高者做校验，否则存在 bug: https://github.com/alibaba/formily/issues/474</span></span><br><span class="line">        matchPattern.matchAliasGroup(state.name, state.path)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> state = <span class="keyword">new</span> FormState(options)    <span class="comment">// 创建 FormState 实例</span></span><br><span class="line">  <span class="keyword">const</span> validator = <span class="keyword">new</span> FormValidator(&#123;   <span class="comment">// 创建 FormValidator 实例</span></span><br><span class="line">    ...options,</span><br><span class="line">    matchStrategy</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">const</span> graph: FormGraph = <span class="keyword">new</span> FormGraph(&#123; <span class="comment">// 创建 FormGraph 实例</span></span><br><span class="line">    matchStrategy</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> formApi = &#123;                       <span class="comment">// Form 实例向外输出的 API</span></span><br><span class="line">    registerField,                        <span class="comment">// 注册表单项</span></span><br><span class="line">    registerVirtualField,                 <span class="comment">// 注册虚拟表单项</span></span><br><span class="line">    </span><br><span class="line">    getFormState,                         <span class="comment">// 读取表单状态</span></span><br><span class="line">    setFormState,                         <span class="comment">// 更新表单状态</span></span><br><span class="line">    getFieldState,                        <span class="comment">// 读取表单项状态</span></span><br><span class="line">    setFieldState,                        <span class="comment">// 更新表单项状态</span></span><br><span class="line">    getFormGraph,                         <span class="comment">// 读取表单状态图</span></span><br><span class="line">    setFormGraph,                         <span class="comment">// 更新表单状态图</span></span><br><span class="line">    validate,                             <span class="comment">// 校验表单</span></span><br><span class="line">    submit,                               <span class="comment">// 提交表单</span></span><br><span class="line">    subscribe: <span class="function">(<span class="params">callback?: FormHeartSubscriber</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> heart.subscribe(callback)</span><br><span class="line">    &#125;,</span><br><span class="line">    unsubscribe: <span class="function">(<span class="params">id: number</span>) =&gt;</span> &#123;</span><br><span class="line">      heart.unsubscribe(id)</span><br><span class="line">    &#125;,</span><br><span class="line">    notify: &lt;T&gt;(type: string, payload: T) =&gt; &#123;</span><br><span class="line">      heart.publish(type, payload)</span><br><span class="line">    &#125;,</span><br><span class="line">    // ...省略其他方法</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const heart = new FormHeart(&#123;           // 创建 FormHeart 实例</span><br><span class="line">    ...options,</span><br><span class="line">    context: formApi,</span><br><span class="line">    beforeNotify: payload =&gt; &#123;</span><br><span class="line">      env.publishing[payload.path || ''] = true</span><br><span class="line">    &#125;,</span><br><span class="line">    afterNotify: payload =&gt; &#123;</span><br><span class="line">      env.publishing[payload.path || ''] = false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"> </span><br><span class="line">  heart.publish(LifeCycleTypes.ON_FORM_WILL_INIT, state)</span><br><span class="line">  state.subscription = &#123;                  // 订阅 FormState 实例上的事件</span><br><span class="line">    notify: onFormChange</span><br><span class="line">  &#125;</span><br><span class="line">  graph.appendNode('', state)             // FormState 实例添加到 FormGraph 实例中</span><br><span class="line">  state.setState((state: IFormState) =&gt; &#123; // 标记 FormState 实例初始化完成</span><br><span class="line">    state.initialized = true</span><br><span class="line">  &#125;)</span><br><span class="line">  graph.subscribe(onGraphChange)          // 订阅 FormGraph 实例上的事件</span><br><span class="line">  return formApi</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="表单-API-注册表单项"><a href="#表单-API-注册表单项" class="headerlink" title="表单 API - 注册表单项"></a>表单 API - 注册表单项</h3><h4 id="概述-6"><a href="#概述-6" class="headerlink" title="概述"></a>概述</h4><p>在创建表单实例时，内部创建了两个创建表单项的重要方法，并作为 FormApi 提供给开发者使用：</p>
<ul>
<li>registerField</li>
<li>registerVirtualField</li>
</ul>
<h4 id="源码分析-6"><a href="#源码分析-6" class="headerlink" title="源码分析"></a>源码分析</h4><p><strong>registerField</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerField</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    path,</span></span></span><br><span class="line"><span class="function"><span class="params">    name,</span></span></span><br><span class="line"><span class="function"><span class="params">    value,</span></span></span><br><span class="line"><span class="function"><span class="params">    initialValue,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="regexp">//</span> ...省略其他参数属性</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;: Exclude&lt;IFieldStateProps, <span class="string">'dataPath'</span> | <span class="string">'nodePath'</span>&gt;</span>): <span class="title">IField</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> nodePath = FormPath.parse(path || name) <span class="comment">// 路径，包含虚拟表单项</span></span><br><span class="line">    <span class="keyword">const</span> dataPath = transformDataPath(nodePath)  <span class="comment">// 数据路径，一般不包含虚拟表单项（除非匹配的表单项本身是虚拟表单项）</span></span><br><span class="line">    <span class="keyword">const</span> createField = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> field = <span class="keyword">new</span> FieldState(&#123;    <span class="comment">// 创建 FieldState 实例</span></span><br><span class="line">          nodePath,</span><br><span class="line">          dataPath</span><br><span class="line">        &#125;)</span><br><span class="line">      field.subscription = &#123;            <span class="comment">// 监听 FieldState 实例上的事件</span></span><br><span class="line">        notify: onFieldChange(&#123; field, <span class="attr">path</span>: nodePath &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      heart.publish(LifeCycleTypes.ON_FIELD_WILL_INIT, field)</span><br><span class="line">      graph.appendNode(nodePath, field) <span class="comment">// FieldState 实例添加到 FormGraph 实例中</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 设置 FieldState 实例上的状态属性</span></span><br><span class="line">      field.setState(<span class="function">(<span class="params">state: IFieldState&lt;FormilyCore.FieldProps&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">        state.initialValue = initialValue || formInitialValue <span class="comment">// 设置 initialValue 属性</span></span><br><span class="line">        state.value = value || formValue || initialValue <span class="comment">// 设置 value 属性</span></span><br><span class="line">        <span class="comment">// ...省略设置 visible、display、props、required、rules、editable 属性</span></span><br><span class="line">       state.initialized = <span class="literal">true</span>                          <span class="comment">// 设置 initialized 标志</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 注册校验规则, validator 为 FormValidator 实例，详见 FormValidator 部分</span></span><br><span class="line">      validator.register(nodePath, validate =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;value, rules&#125; = field.getState()</span><br><span class="line">        heart.publish(LifeCycleTypes.ON_FIELD_VALIDATE_START, field)</span><br><span class="line">        <span class="keyword">return</span> validate(value, rules).then(<span class="function">(<span class="params">&#123; errors, warnings &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">            field.setState(<span class="function">(<span class="params">state: IFieldState&lt;FormilyCore.FieldProps&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">              state.ruleErrors = errors                 <span class="comment">// 设置 ruleErrors 属性</span></span><br><span class="line">              state.ruleWarnings = warnings             <span class="comment">// 设置 ruleWarnings 属性</span></span><br><span class="line">            &#125;)</span><br><span class="line">            heart.publish(LifeCycleTypes.ON_FIELD_VALIDATE_END, field)</span><br><span class="line">            resolve(&#123;errors, warnings&#125;)                 <span class="comment">// 返回校验结果</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">return</span> field</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> createField()</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><strong>registerVirtualField</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * registerVirtualField 相比 registerField 更简单，没有 value 值的初始化、设置、校验</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">registerVirtualField</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    name,</span></span></span><br><span class="line"><span class="function"><span class="params">    path,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="regexp">//</span> ...省略其他参数属性</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;: IVirtualFieldStateProps</span>): <span class="title">IVirtualField</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> nodePath = FormPath.parse(path || name)</span><br><span class="line">    <span class="keyword">const</span> dataPath = transformDataPath(nodePath)</span><br><span class="line">    <span class="keyword">const</span> createField = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> field = <span class="keyword">new</span> VirtualFieldState(&#123; <span class="comment">// 创建 VirtualFieldState 实例</span></span><br><span class="line">          nodePath,</span><br><span class="line">          dataPath,</span><br><span class="line">        &#125;)</span><br><span class="line">      field.subscription = &#123;</span><br><span class="line">        notify: onVirtualFieldChange(&#123; field, <span class="attr">path</span>: nodePath &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      field.setState(</span><br><span class="line">        (state: IVirtualFieldState&lt;FormilyCore.VirtualFieldProps&gt;) =&gt; &#123;</span><br><span class="line">          state.initialized = <span class="literal">true</span></span><br><span class="line">          <span class="comment">// 设置 visible、display、props 属性</span></span><br><span class="line">          state.props = props</span><br><span class="line">          <span class="keyword">if</span> (isValid(visible)) &#123;</span><br><span class="line">            state.visible = visible</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (isValid(display)) &#123;</span><br><span class="line">            state.display = display</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">return</span> field</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> createField()</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="表单-API-读写表单状态"><a href="#表单-API-读写表单状态" class="headerlink" title="表单 API - 读写表单状态"></a>表单 API - 读写表单状态</h3><h4 id="概述-7"><a href="#概述-7" class="headerlink" title="概述"></a>概述</h4><p>在创建表单实例时，内部创建了几个读写状态的重要方法，并作为 FormApi 提供给开发者使用：</p>
<ul>
<li>getFormState、setFormState</li>
<li>getFieldState、setFieldState</li>
<li>getFormGraph、setFormGraph</li>
</ul>
<h4 id="源码分析-7"><a href="#源码分析-7" class="headerlink" title="源码分析"></a>源码分析</h4><p><strong>getFormState、setFormState</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFormState</span>(<span class="params">callback?: (state: IFormState</span>) =&gt; <span class="title">any</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> state.getState(callback) <span class="comment">// FormState 实例 getState 方法读取状态</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setFormState</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  callback?: (state: IFormState</span>) =&gt; <span class="title">any</span>,</span></span><br><span class="line"><span class="function">  <span class="title">silent</span>?: <span class="title">boolean</span></span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  state.setState(callback, silent) <span class="comment">// FormState 实例 setState 方法更新状态</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>getFieldState、setFieldState</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFieldState</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  path: FormPathPattern,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback?: (state: IFieldState&lt;FormilyCore.FieldProps&gt;</span>) =&gt; <span class="title">any</span></span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> field = graph.select(path) <span class="comment">// FormGraph 实例 select 方法模糊匹配路径</span></span><br><span class="line">  <span class="keyword">return</span> field &amp;&amp; field.getState(callback) <span class="comment">// FormState 、FieldState、VirtualFieldState 实例 getState 方法读取状态</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setFieldState</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  path: FormPathPattern,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback?: (state: IFieldState&lt;FormilyCore.FieldProps&gt;</span>) =&gt; <span class="title">void</span>,</span></span><br><span class="line"><span class="function">  <span class="title">silent</span>?: <span class="title">boolean</span></span></span><br><span class="line"><span class="function">) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isFn(callback)) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">const</span> pattern = FormPath.getPath(path)</span><br><span class="line">  graph.select(pattern, field =&gt; &#123;   <span class="comment">// FormGraph 实例 select 方法模糊匹配路径</span></span><br><span class="line">    field.setState(callback, silent) <span class="comment">// FormState 、FieldState、VirtualFieldState 实例 setState 方法更新状态</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>getFormGraph、setFormGraph</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFormGraph</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> graph.map(<span class="function"><span class="params">node</span> =&gt;</span> &#123; <span class="comment">// FormGraph 实例 map 方法遍历映射表，返回新的映射表</span></span><br><span class="line">    <span class="keyword">return</span> node.getState()   <span class="comment">// FormState 、FieldState、VirtualFieldState 实例 getState 方法读取状态</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setFormGraph</span>(<span class="params">nodes: &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  each(                            <span class="comment">// 遍历所有需要更新的节点，逐个更新</span></span><br><span class="line">    nodes,</span><br><span class="line">    (</span><br><span class="line">      node:</span><br><span class="line">        | IFieldState&lt;FormilyCore.FieldProps&gt;</span><br><span class="line">        | IVirtualFieldState&lt;FormilyCore.VirtualFieldProps&gt;,</span><br><span class="line">      key</span><br><span class="line">    ) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> nodeState: any</span><br><span class="line">      <span class="keyword">if</span> (graph.exist(key)) &#123;      <span class="comment">// 已存在对应状态节点</span></span><br><span class="line">        nodeState = graph.get(key) <span class="comment">// FormGraph 实例 get 方法精确匹配路径</span></span><br><span class="line">        nodeState.setSourceState(<span class="function"><span class="params">state</span> =&gt;</span> &#123; <span class="comment">// FormState 、FieldState、VirtualFieldState 实例 setSourceState 返回 state 对象，可通过 js 对象引用特性修改</span></span><br><span class="line">          <span class="built_in">Object</span>.assign(state, node)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;                     <span class="comment">// 不存在对应状态节点</span></span><br><span class="line">        <span class="keyword">if</span> (node.displayName === <span class="string">'VirtualFieldState'</span>) &#123; <span class="comment">// 新建虚拟表单项后更新</span></span><br><span class="line">          nodeState = registerVirtualField(&#123;</span><br><span class="line">            path: key</span><br><span class="line">          &#125;)</span><br><span class="line">          nodeState.setSourceState(<span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">Object</span>.assign(state, node)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.displayName === <span class="string">'FieldState'</span>) &#123; <span class="comment">// 新建表单项后更新</span></span><br><span class="line">          nodeState = registerField(&#123;</span><br><span class="line">            path: key</span><br><span class="line">          &#125;)</span><br><span class="line">          nodeState.setSourceState(<span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">Object</span>.assign(state, node)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (nodeState) &#123;</span><br><span class="line">        nodeState.notify(state.getState()) <span class="comment">// FormState 、FieldState、VirtualFieldState 实例 notify 方法发布事件通知更新（因为 setSourceState 方法不会通知，而 getState 方法会通知）。触发 onFormChange、onFieldChange、onVirtualFieldChange</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="表单-API-监听表单更新"><a href="#表单-API-监听表单更新" class="headerlink" title="表单 API - 监听表单更新"></a>表单 API - 监听表单更新</h3><h4 id="概述-8"><a href="#概述-8" class="headerlink" title="概述"></a>概述</h4><p>在创建表单实例时，内部创建了几个监听状态更新的重要方法，仅表单实例内部使用：</p>
<ul>
<li>onFormChange</li>
<li>onFieldChange</li>
<li>onVirtualFieldChange</li>
<li>onGraphChange</li>
</ul>
<h4 id="源码分析-8"><a href="#源码分析-8" class="headerlink" title="源码分析"></a>源码分析</h4><p><strong>公共函数</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从 FormState 实例的 values 属性中获取对应数据路径的值，更新 value</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">syncFieldValues</span>(<span class="params">state: IFieldState</span>) </span>&#123;</span><br><span class="line">  state.value = getFormValuesIn(state.name)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 从 FormState 实例的 initialValues 属性中获取对应数据路径的值，更新 initialValue。并结合 value 是否有效，判断是否更新到 value</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">syncFieldIntialValues</span>(<span class="params">state: IFieldState</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> initialValue = getFormInitialValuesIn(state.name)</span><br><span class="line">  state.initialValue = initialValue</span><br><span class="line">  <span class="keyword">if</span> (!isValid(state.value) || isEmpty(state.value)) &#123;</span><br><span class="line">      state.value = initialValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>onGraphChange</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听表单状态图更新</span></span><br><span class="line"><span class="comment"> * 订阅时机：上面"创建表单实例" createForm 方法中 graph.subscribe(onGraphChange)</span></span><br><span class="line"><span class="comment"> * 触发时机：FormGraph 实例上的 appendNode、remove、replace 方法内部会触发，也可直接调用 notify 方法触发</span></span><br><span class="line"><span class="comment"> */</span>   </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onGraphChange</span>(<span class="params">&#123; type, payload &#125;</span>) </span>&#123;</span><br><span class="line">  heart.publish(LifeCycleTypes.ON_FORM_GRAPH_CHANGE, graph)</span><br><span class="line">  <span class="keyword">if</span> (type === <span class="string">'GRAPH_NODE_WILL_UNMOUNT'</span>) &#123;</span><br><span class="line">    <span class="comment">// 移除对将取消挂载的节点的校验</span></span><br><span class="line">    validator.unregister(payload.path.toString())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>onFormChange</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听表单状态更新</span></span><br><span class="line"><span class="comment"> * 订阅时机：上面"创建表单实例" createForm 方法中 state.subscription = &#123;notify: onFormChange&#125;</span></span><br><span class="line"><span class="comment"> * 触发时机：FormState 实例上的 batch、setState 方法内部会触发，也可直接调用 notify 方法触发</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onFormChange</span>(<span class="params">published: IFormState</span>) </span>&#123;</span><br><span class="line">  heart.publish(LifeCycleTypes.ON_FORM_CHANGE, state)</span><br><span class="line">  <span class="keyword">const</span> valuesChanged = state.isDirty(<span class="string">'values'</span>)</span><br><span class="line">  <span class="keyword">const</span> initialValuesChanged = state.isDirty(<span class="string">'initialValues'</span>)</span><br><span class="line">  <span class="keyword">const</span> unmountedChanged = state.isDirty(<span class="string">'unmounted'</span>)</span><br><span class="line">  <span class="keyword">const</span> mountedChanged = state.isDirty(<span class="string">'mounted'</span>)</span><br><span class="line">  <span class="keyword">const</span> initializedChanged = state.isDirty(<span class="string">'initialized'</span>)</span><br><span class="line">  <span class="keyword">const</span> editableChanged = state.isDirty(<span class="string">'editable'</span>)</span><br><span class="line">  <span class="comment">// values 或 initialValues 变化</span></span><br><span class="line">  <span class="keyword">if</span> (valuesChanged || initialValuesChanged) &#123;</span><br><span class="line">    <span class="keyword">const</span> updateFields = <span class="function">(<span class="params">field: IField | IVirtualField</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isField(field)) &#123;</span><br><span class="line">        field.setState(<span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (valuesChanged) &#123;</span><br><span class="line">            syncFieldValues(state)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (initialValuesChanged) &#123;</span><br><span class="line">            syncFieldIntialValues(state)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// values 或 initialValues 变化，更新每个表单项对应的值</span></span><br><span class="line">    <span class="keyword">if</span> (valuesChanged || initialValuesChanged) &#123;</span><br><span class="line">      graph.eachChildren(updateFields) <span class="comment">// 遍历更新表单项</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// values 变化，主动调用创建 Form 实例时传入的 onChange 方法，并</span></span><br><span class="line">    <span class="keyword">if</span> (valuesChanged) &#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        isFn(options.onChange) &amp;&amp;</span><br><span class="line">        state.state.mounted &amp;&amp;</span><br><span class="line">        !state.state.unmounted</span><br><span class="line">      ) &#123;</span><br><span class="line">        options.onChange(clone(getFormValuesIn(<span class="string">''</span>))) <span class="comment">// 调用 onChange 方法，实参为 FormState.values 属性</span></span><br><span class="line">      &#125;</span><br><span class="line">      heart.publish(LifeCycleTypes.ON_FORM_VALUES_CHANGE, state)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (initialValuesChanged) &#123;</span><br><span class="line">      heart.publish(LifeCycleTypes.ON_FORM_INITIAL_VALUES_CHANGE, state)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 编辑态变化</span></span><br><span class="line">  <span class="keyword">if</span> (editableChanged) &#123;</span><br><span class="line">    graph.eachChildren(<span class="function">(<span class="params">field: IField | IVirtualField</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isField(field)) &#123;</span><br><span class="line">        field.setState(<span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">          state.formEditable = published.editable</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 挂载状态变化</span></span><br><span class="line">  <span class="keyword">if</span> (unmountedChanged &amp;&amp; published.unmounted) &#123;</span><br><span class="line">    heart.publish(LifeCycleTypes.ON_FORM_UNMOUNT, state)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (mountedChanged &amp;&amp; published.mounted) &#123;</span><br><span class="line">    heart.publish(LifeCycleTypes.ON_FORM_MOUNT, state)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 初始化状态变化</span></span><br><span class="line">  <span class="keyword">if</span> (initializedChanged) &#123;</span><br><span class="line">    heart.publish(LifeCycleTypes.ON_FORM_INIT, state)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>onFieldChange</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听表单项状态更新</span></span><br><span class="line"><span class="comment"> * 订阅时机：上面"注册表单项" registerField 方法中 field.subscription = &#123;notify: onFieldChange(&#123; field, path: nodePath &#125;)&#125;</span></span><br><span class="line"><span class="comment"> * 触发时机：FieldState 实例上的 batch、setState 方法内部会触发，也可直接调用 notify 方法触发</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onFieldChange</span>(<span class="params">&#123; field, path &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 更新表单项及所有层次的父子节点的 value</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">notifyTreeFromValues</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    field.setState(syncFieldValues)</span><br><span class="line">    graph.eachParent(path, (field: IField) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (isField(field)) &#123;</span><br><span class="line">        field.setState(syncFieldValues, <span class="literal">true</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    graph.eachChildren(path, (field: IField) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (isField(field)) &#123;</span><br><span class="line">        field.setState(syncFieldValues)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    notifyFormValuesChange()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 更新表单项及所有层次的父子节点的 initialValue</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">notifyTreeFromInitialValues</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    field.setState(syncFieldIntialValues)</span><br><span class="line">    graph.eachParent(path, (field: IField) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (isField(field)) &#123;</span><br><span class="line">        field.setState(syncFieldIntialValues, <span class="literal">true</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    graph.eachChildren(path, (field: IField) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (isField(field)) &#123;</span><br><span class="line">        field.setState(syncFieldIntialValues)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    notifyFormInitialValuesChange()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">published: IFieldState&lt;FormilyCore.FieldProps&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> valueChanged = field.isDirty(<span class="string">'value'</span>)</span><br><span class="line">    <span class="keyword">const</span> initialValueChanged = field.isDirty(<span class="string">'initialValue'</span>)</span><br><span class="line">    <span class="keyword">const</span> visibleChanged = field.isDirty(<span class="string">'visible'</span>)</span><br><span class="line">    <span class="keyword">const</span> displayChanged = field.isDirty(<span class="string">'display'</span>)</span><br><span class="line">    <span class="keyword">const</span> mountedChanged = field.isDirty(<span class="string">'mounted'</span>)</span><br><span class="line">    <span class="keyword">const</span> initializedChanged = field.isDirty(<span class="string">'initialized'</span>)</span><br><span class="line">    <span class="comment">// ...省略其他状态</span></span><br><span class="line">    <span class="keyword">if</span> (initializedChanged) &#123;</span><br><span class="line">      heart.publish(LifeCycleTypes.ON_FIELD_INIT, field)</span><br><span class="line">      <span class="comment">// ...省略对空 value 或空 initialValue 的特殊处理</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 表单项是否隐藏或未挂载</span></span><br><span class="line">    <span class="keyword">const</span> wasHidden =</span><br><span class="line">      published.visible == <span class="literal">false</span> || published.unmounted === <span class="literal">true</span></span><br><span class="line">    <span class="comment">// 表单项 value 变化，显示在页面中时，先更新表单中的 values，再更新表单项及父子表单项的 value</span></span><br><span class="line">    <span class="keyword">if</span> (valueChanged) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!wasHidden) &#123;</span><br><span class="line">        setFormValuesIn(path, published.value, <span class="literal">true</span>)</span><br><span class="line">        notifyTreeFromValues()</span><br><span class="line">      &#125;</span><br><span class="line">      heart.publish(LifeCycleTypes.ON_FIELD_VALUE_CHANGE, field)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 表单项 initialValue 变化，显示在页面中时，先更新表单中的 initialValues，再更新表单项及父子表单项的 initialValue</span></span><br><span class="line">    <span class="keyword">if</span> (initialValueChanged) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!wasHidden) &#123;</span><br><span class="line">        setFormInitialValuesIn(path, published.initialValue, <span class="literal">true</span>)</span><br><span class="line">        notifyTreeFromInitialValues()</span><br><span class="line">      &#125;</span><br><span class="line">      heart.publish(LifeCycleTypes.ON_FIELD_INITIAL_VALUE_CHANGE, field)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// display 或 visible 变化；visible：数据与样式是否可见，display：样式是否可见</span></span><br><span class="line">    <span class="keyword">if</span> (displayChanged || visibleChanged) &#123;</span><br><span class="line">      <span class="keyword">if</span> (visibleChanged) &#123;               <span class="comment">// visible 变化引起的数据的删除与恢复</span></span><br><span class="line">        <span class="keyword">if</span> (!published.visible) &#123;         <span class="comment">// visible 从 true 更新为 false</span></span><br><span class="line">          <span class="keyword">if</span> (isValid(published.value)) &#123; <span class="comment">// 暂存有效的 value</span></span><br><span class="line">            field.setSourceState(</span><br><span class="line">              (state: IFieldState&lt;FormilyCore.FieldProps&gt;) =&gt; &#123;</span><br><span class="line">                state.visibleCacheValue = published.value</span><br><span class="line">              &#125;</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">          deleteFormValuesIn(path)        <span class="comment">// 删除 FormState 实例 values 对应数据 </span></span><br><span class="line">          notifyTreeFromValues()          <span class="comment">// 更新表单项及所有层次的父子节点的 value，由于是从 FormState 实例 values 中获取的，表单项及所有层级的子节点的 value 都会置为 undefined</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;                          <span class="comment">// visible 从 false 更新为 true</span></span><br><span class="line">          <span class="keyword">if</span> (!existFormValuesIn(path)) &#123; <span class="comment">// 若数据已删除，则从尝试从之前的暂存中设置值，否则直接取初始化值。先更新到 FormState 实例 values 中，再更新表单项及所有层次的父子节点的 value</span></span><br><span class="line">            setFormValuesIn(</span><br><span class="line">              path,</span><br><span class="line">              isValid(published.visibleCacheValue)</span><br><span class="line">                ? published.visibleCacheValue</span><br><span class="line">                : published.initialValue,</span><br><span class="line">              <span class="literal">true</span></span><br><span class="line">            )</span><br><span class="line">            notifyTreeFromValues()</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 更新表单项所有层次的子节点的 visible 或 display</span></span><br><span class="line">      graph.eachChildren(path, childState =&gt; &#123;</span><br><span class="line">        childState.setState(<span class="function">(<span class="params">state: IFieldState&lt;FormilyCore.FieldProps&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (visibleChanged) &#123;</span><br><span class="line">            updateRecoverableShownState(published, state, <span class="string">'visible'</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (displayChanged) &#123;</span><br><span class="line">            updateRecoverableShownState(published, state, <span class="string">'display'</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, <span class="literal">true</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// unmount 变化，删除或恢复数据</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      unmountedChanged &amp;&amp;</span><br><span class="line">      (published.display !== <span class="literal">false</span> || published.visible === <span class="literal">false</span>) &amp;&amp;</span><br><span class="line">      published.unmountRemoveValue === <span class="literal">true</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (published.unmounted) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isValid(published.value)) &#123;</span><br><span class="line">          field.setSourceState(</span><br><span class="line">            (state: IFieldState&lt;FormilyCore.FieldProps&gt;) =&gt; &#123;</span><br><span class="line">              state.visibleCacheValue = published.value</span><br><span class="line">            &#125;</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">        deleteFormValuesIn(path, <span class="literal">true</span>)</span><br><span class="line">        notifyTreeFromValues()</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!existFormValuesIn(path)) &#123;</span><br><span class="line">          setFormValuesIn(</span><br><span class="line">            path,</span><br><span class="line">            isValid(published.visibleCacheValue)</span><br><span class="line">              ? published.visibleCacheValue</span><br><span class="line">              : published.initialValue,</span><br><span class="line">            <span class="literal">true</span></span><br><span class="line">          )</span><br><span class="line">          notifyTreeFromValues()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      heart.publish(LifeCycleTypes.ON_FIELD_UNMOUNT, field)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mountedChanged &amp;&amp; published.mounted) &#123;</span><br><span class="line">      heart.publish(LifeCycleTypes.ON_FIELD_MOUNT, field)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...省略 errors 和 warnings 变化的同步</span></span><br><span class="line">    heart.publish(LifeCycleTypes.ON_FIELD_CHANGE, field)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>onVirtualFieldChange</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听虚拟表单项状态更新，onFieldChange 去除 value 和 initialValue 的简单版本</span></span><br><span class="line"><span class="comment"> * 订阅时机：上面"注册表单项" registerVirtualField 方法中 field.subscription = &#123;notify: onVirtualFieldChange(&#123; field, path: nodePath &#125;)&#125;</span></span><br><span class="line"><span class="comment"> * 触发时机：VirtualFieldState 实例上的 batch、setState 方法内部会触发，也可直接调用 notify 方法触发</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onVirtualFieldChange</span>(<span class="params">&#123; field, path &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">published: IVirtualFieldState&lt;FormilyCore.VirtualFieldProps&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> visibleChanged = field.isDirty(<span class="string">'visible'</span>)</span><br><span class="line">    <span class="keyword">const</span> displayChanged = field.isDirty(<span class="string">'display'</span>)</span><br><span class="line">    <span class="keyword">const</span> mountedChanged = field.isDirty(<span class="string">'mounted'</span>)</span><br><span class="line">    <span class="keyword">const</span> initializedChanged = field.isDirty(<span class="string">'initialized'</span>)</span><br><span class="line">    <span class="keyword">if</span> (initializedChanged) &#123;</span><br><span class="line">      heart.publish(LifeCycleTypes.ON_FIELD_INIT, field)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// visible 或 display 变化时, 更新表单项所有层次的子节点的 visible 或 display</span></span><br><span class="line">    <span class="keyword">if</span> (visibleChanged || displayChanged) &#123;</span><br><span class="line">      graph.eachChildren(path, childState =&gt; &#123;</span><br><span class="line">        childState.setState(</span><br><span class="line">          (state: IVirtualFieldState&lt;FormilyCore.VirtualFieldProps&gt;) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (visibleChanged) &#123;</span><br><span class="line">              updateRecoverableShownState(published, state, <span class="string">'visible'</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (displayChanged) &#123;</span><br><span class="line">              updateRecoverableShownState(published, state, <span class="string">'display'</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="literal">true</span></span><br><span class="line">        )</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mountedChanged &amp;&amp; published.mounted) &#123;</span><br><span class="line">      heart.publish(LifeCycleTypes.ON_FIELD_MOUNT, field)</span><br><span class="line">    &#125;</span><br><span class="line">    heart.publish(LifeCycleTypes.ON_FIELD_CHANGE, field)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="表单-API-表单校验和提交"><a href="#表单-API-表单校验和提交" class="headerlink" title="表单 API - 表单校验和提交"></a>表单 API - 表单校验和提交</h3><h4 id="概述-9"><a href="#概述-9" class="headerlink" title="概述"></a>概述</h4><p>在创建表单实例时，内部创建了校验和提交表单的方法，并作为 FormApi 提供给开发者使用：</p>
<ul>
<li>validate</li>
<li>submit</li>
</ul>
<h4 id="源码分析-9"><a href="#源码分析-9" class="headerlink" title="源码分析"></a>源码分析</h4><p><strong>validate</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  path?: FormPathPattern,</span></span></span><br><span class="line"><span class="function"><span class="params">  opts?: IFormExtendedValidateFieldOptions</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Promise</span>&lt;<span class="title">IFormValidateResult</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; throwErrors = <span class="literal">true</span>, hostRendering &#125; = opts || &#123;&#125;</span><br><span class="line">  <span class="comment">// 设置 FormState 实例的 validating 为 true，并通知更新</span></span><br><span class="line">  <span class="keyword">if</span> (!state.getState(<span class="function"><span class="params">state</span> =&gt;</span> state.validating)) &#123;</span><br><span class="line">    state.setSourceState(<span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">      state.validating = <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 渲染优化</span></span><br><span class="line">    clearTimeout(env.validateTimer)</span><br><span class="line">    env.validateTimer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      state.notify()</span><br><span class="line">    &#125;, <span class="number">60</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  heart.publish(LifeCycleTypes.ON_FORM_VALIDATE_START, state)</span><br><span class="line">  <span class="comment">// 调用 FormValidator 实例的 validate 方法校验指定路径的数据</span></span><br><span class="line">  <span class="keyword">const</span> payload = <span class="keyword">await</span> validator.validate(path, opts)</span><br><span class="line">  <span class="comment">// 设置 FormState 实例的 validating 为 false</span></span><br><span class="line">  state.setState(<span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">    state.validating = <span class="literal">false</span></span><br><span class="line">  &#125;)</span><br><span class="line">  heart.publish(LifeCycleTypes.ON_FORM_VALIDATE_END, state)</span><br><span class="line">  <span class="comment">// 增加校验结果增加 name 数据路径，和 0.x 保持一致</span></span><br><span class="line">  <span class="keyword">const</span> result = &#123;</span><br><span class="line">    errors: payload.errors.map(<span class="function"><span class="params">item</span> =&gt;</span> (&#123;</span><br><span class="line">      ...item,</span><br><span class="line">      name: getFieldState(item.path).name</span><br><span class="line">    &#125;)),</span><br><span class="line">    warnings: payload.warnings.map(<span class="function"><span class="params">item</span> =&gt;</span> (&#123;</span><br><span class="line">      ...item,</span><br><span class="line">      name: getFieldState(item.path).name</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> &#123; errors, warnings &#125; = result</span><br><span class="line">  <span class="comment">// 打印 warnings 日志</span></span><br><span class="line">  <span class="keyword">if</span> (warnings.length) &#123;</span><br><span class="line">    log.warn(warnings)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// throwErrors 配置默认 true，检测到错误会抛错；若设置为 false，则不抛错直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (errors.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (throwErrors) &#123;</span><br><span class="line">      <span class="keyword">throw</span> result</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>submit</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">submit</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  onSubmit?: (values: IFormState[<span class="string">'values'</span>]</span>) =&gt; <span class="title">any</span> | <span class="title">Promise</span>&lt;<span class="title">any</span>&gt;</span></span><br><span class="line"><span class="function">): <span class="title">Promise</span>&lt;<span class="title">IFormSubmitResult</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 重复提交，直接返回，且 submit 方法的返回值不重要，主要在于 validate 过程和 onSubmit 回调</span></span><br><span class="line">  <span class="keyword">if</span> (state.getState(<span class="function"><span class="params">state</span> =&gt;</span> state.submitting)) <span class="keyword">return</span> env.submittingTask</span><br><span class="line">  heart.publish(LifeCycleTypes.ON_FORM_SUBMIT_START, state)</span><br><span class="line">  onSubmit = onSubmit || options.onSubmit</span><br><span class="line">  <span class="comment">// 设置 submitting 为 true</span></span><br><span class="line">  state.setState(<span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">    state.submitting = <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">  env.submittingTask = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    heart.publish(LifeCycleTypes.ON_FORM_SUBMIT_VALIDATE_START, state)</span><br><span class="line">    <span class="comment">// '' 路径对应的节点是 FormState 的实例，即校验整个表单状态</span></span><br><span class="line">    <span class="keyword">await</span> validate(<span class="string">''</span>, &#123; <span class="attr">throwErrors</span>: <span class="literal">false</span>, <span class="attr">hostRendering</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    <span class="comment">// 从 FormState 的实例上获取 errors、warnings</span></span><br><span class="line">    <span class="keyword">const</span> validated: IFormValidateResult = state.getState(<span class="function"><span class="params">state</span> =&gt;</span> (&#123;</span><br><span class="line">      errors: state.errors,</span><br><span class="line">      warnings: state.warnings</span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="keyword">const</span> &#123; errors &#125; = validated</span><br><span class="line">    <span class="comment">// 校验失败</span></span><br><span class="line">    <span class="keyword">if</span> (errors.length) &#123;</span><br><span class="line">      <span class="comment">// 由于校验失败导致 submit 退出</span></span><br><span class="line">      state.setState(<span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">        state.submitting = <span class="literal">false</span></span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="comment">// 增加 onFormSubmitValidateFailed 来明确结束 submit 的类型</span></span><br><span class="line">      heart.publish(LifeCycleTypes.ON_FORM_SUBMIT_VALIDATE_FAILED, state)</span><br><span class="line">      heart.publish(LifeCycleTypes.ON_FORM_SUBMIT_END, state)</span><br><span class="line">      <span class="keyword">if</span> (isFn(options.onValidateFailed) &amp;&amp; !state.state.unmounted) &#123;</span><br><span class="line">        options.onValidateFailed(validated)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> errors</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 增加 onFormSubmitValidateSucces 来明确 submit 引起的校验最终的结果</span></span><br><span class="line">    heart.publish(LifeCycleTypes.ON_FORM_SUBMIT_VALIDATE_SUCCESS, state)</span><br><span class="line">    heart.publish(LifeCycleTypes.ON_FORM_SUBMIT, state)</span><br><span class="line">    <span class="comment">// 获取 payload、values，应该是为了避免在 onSubmit 中修改数据，采用了深拷贝</span></span><br><span class="line">    <span class="keyword">let</span> payload, values = state.getState(<span class="function"><span class="params">state</span> =&gt;</span> clone(state.values))</span><br><span class="line">    <span class="keyword">if</span> (isFn(onSubmit) &amp;&amp; !state.state.unmounted) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        payload = <span class="keyword">await</span> <span class="built_in">Promise</span>.resolve(onSubmit(values))</span><br><span class="line">        heart.publish(LifeCycleTypes.ON_FORM_ON_SUBMIT_SUCCESS, payload)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        heart.publish(LifeCycleTypes.ON_FORM_ON_SUBMIT_FAILED, e)</span><br><span class="line">        <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> e</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置 submitting 为 true</span></span><br><span class="line">    state.setState(<span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">      state.submitting = <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">    heart.publish(LifeCycleTypes.ON_FORM_SUBMIT_END, state)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      values,</span><br><span class="line">      validated,</span><br><span class="line">      payload</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> env.submittingTask()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UI-桥接层-formily-react"><a href="#UI-桥接层-formily-react" class="headerlink" title="UI 桥接层 - @formily/react"></a>UI 桥接层 - @formily/react</h2><blockquote>
<ul>
<li>UI 桥接层(React/Vue/Angular/小程序….)，这一层主要是对接各种组件化框架，对不同体系的用户提供更便捷的表单管理方案</li>
</ul>
</blockquote>
<p>目前只接入了 React</p>
<h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><h4 id="概述-10"><a href="#概述-10" class="headerlink" title="概述"></a>概述</h4><p>由于封装的组件和提供的 API 很多，而且逻辑比较分散独立，这里不再一一介绍。以具有代表性的 FormSpy 组件为例，初步体会桥接层的设计分工：对接框架，提供便捷实用的版本。</p>
<h4 id="源码分析-10"><a href="#源码分析-10" class="headerlink" title="源码分析"></a>源码分析</h4><p><strong>FormSpy</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string | string[]&#125;</span> </span>props.selector - 事件类型选择器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;(state: any, action: &#123; type: string; payload: any &#125;</span></span>, form: IForm) =&gt; any&#125; reducer - reducer 函数，状态叠加处理，action 为当前命中的生命周期的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;React.ReactElement | ((api: IFormSpyAPI) =&gt; React.ReactElement)&#125;</span> <span class="variable">children</span></span> - 内容 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> FormSpy: React.FunctionComponent&lt;IFormSpyProps&gt; = <span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (isFn(props.children)) &#123;</span><br><span class="line">    <span class="keyword">return</span> props.children(useFormSpy(props)) || &lt;Fragment /&gt;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> props.children || &lt;Fragment /&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">FormSpy.displayName = <span class="string">'ReactInternalFormSpy'</span></span><br><span class="line">FormSpy.defaultProps = &#123;</span><br><span class="line">  selector: <span class="string">`*`</span>,</span><br><span class="line">  reducer: <span class="function">(<span class="params">state, action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...state,</span><br><span class="line">      ...action.payload</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useFormSpy = (props: IFormSpyProps): <span class="function"><span class="params">ISpyHook</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> form = useContext(FormContext)</span><br><span class="line">  <span class="keyword">const</span> subscriberId = useRef&lt;number&gt;()</span><br><span class="line">  <span class="keyword">const</span> [type, setType] = useState&lt;string&gt;(LifeCycleTypes.ON_FORM_INIT)</span><br><span class="line">  <span class="keyword">const</span> [state, dispatch] = useReducer(</span><br><span class="line">    (state, action) =&gt; props.reducer(state, action, form),</span><br><span class="line">    props.initialState || &#123;&#125;</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">const</span> subscriber = useCallback&lt;FormHeartSubscriber&gt;<span class="function">(<span class="params">(&#123; type, payload &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    payload = payload &amp;&amp; isFn(payload.getState) ? payload.getState() : payload</span><br><span class="line">    <span class="keyword">if</span> (isStr(props.selector) &amp;&amp; FormPath.parse(props.selector).match(type)) &#123;</span><br><span class="line">      <span class="comment">// selector 为字符串类型，正则匹配事件类型</span></span><br><span class="line">      setType(type)</span><br><span class="line">      dispatch(&#123;</span><br><span class="line">        type,</span><br><span class="line">        payload</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isArr(props.selector)) &#123;</span><br><span class="line">      <span class="comment">// selector 为数组类型，精确匹配多个事件类型</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        !!(props.selector <span class="keyword">as</span> any[]).find(<span class="function"><span class="params">str</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (isStr(str)) &#123;</span><br><span class="line">            <span class="keyword">return</span> str === type</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isArr(str)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (str.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span> str[<span class="number">0</span>] === type</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      ) &#123;</span><br><span class="line">        setType(type)</span><br><span class="line">        dispatch(&#123;</span><br><span class="line">          type,</span><br><span class="line">          payload</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line">  useMemo(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// form subscribe 实际上调用的是 heart.subscribe，监听整个 FormHeart 实例上的事件</span></span><br><span class="line">    subscriberId.current = form.subscribe(subscriber)</span><br><span class="line">  &#125;, [])</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (form) &#123;</span><br><span class="line">        form.unsubscribe(subscriberId.current)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [])</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    form,</span><br><span class="line">    type,</span><br><span class="line">    state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Schema-动态渲染层-formily-react-schema-renderer"><a href="#Schema-动态渲染层-formily-react-schema-renderer" class="headerlink" title="Schema 动态渲染层 - @formily/react-schema-renderer"></a>Schema 动态渲染层 - @formily/react-schema-renderer</h2><blockquote>
<ul>
<li>Schema 动态渲染层(React/Vue/Angular/小程序…)，这一层主要提供了针对 Schema 场景下的各种上层能力，比如典型的协议化联动，协议化布局能力</li>
</ul>
</blockquote>
<h3 id="组件-1"><a href="#组件-1" class="headerlink" title="组件"></a>组件</h3><h4 id="概述-11"><a href="#概述-11" class="headerlink" title="概述"></a>概述</h4><p>由于封装的组件和透传的 API 很多，而且逻辑比较分散独立，这里不再一一介绍。以具有代表性的 SchemaField 组件为例，初步体会动态渲染层的设计分工：处理 schema。</p>
<h4 id="源码分析-11"><a href="#源码分析-11" class="headerlink" title="源码分析"></a>源码分析</h4><p><strong>FormSpy</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 由于这一层主要是针对 Schema 场景的处理，不涉及 FormSpy 的实现，因此直接从 react 包导出</span></span><br><span class="line"><span class="keyword">export</span> &#123; FormSpy &#125; <span class="keyword">from</span> <span class="string">'@formily/react'</span></span><br></pre></td></tr></table></figure>

<p><strong>SchemaField</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SchemaField: React.FunctionComponent&lt;ISchemaFieldProps&gt; = (</span><br><span class="line">  props: ISchemaFieldProps</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> path = FormPath.parse(props.path)</span><br><span class="line">  <span class="keyword">const</span> formSchema = useContext(SchemaContext)</span><br><span class="line">  <span class="keyword">const</span> fieldSchema = <span class="keyword">new</span> Schema(props.schema || formSchema.get(path))</span><br><span class="line">  <span class="keyword">const</span> formRegistry = useContext(FormComponentsContext)</span><br><span class="line">  <span class="keyword">const</span> schemaType = fieldSchema.type                       <span class="comment">// 'type'</span></span><br><span class="line">  <span class="keyword">const</span> schemaComponent = fieldSchema.getExtendsComponent() <span class="comment">// 'x-component'</span></span><br><span class="line">  <span class="keyword">const</span> schemaRenderer = fieldSchema.getExtendsRenderer()   <span class="comment">// 'x-render'</span></span><br><span class="line">  <span class="keyword">const</span> initialComponent = schemaComponent || schemaType    <span class="comment">// 'x-component' || 'type'</span></span><br><span class="line">  <span class="keyword">const</span> renderField = ( <span class="comment">// 遍历渲染子节点</span></span><br><span class="line">    addtionKey: string | number,</span><br><span class="line">    reactKey?: string | number</span><br><span class="line">  ) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> &lt;SchemaField key=&#123;reactKey&#125; path=&#123;path.concat(addtionKey)&#125; /&gt;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> renderFieldDelegate = (</span><br><span class="line">    callback: <span class="function">(<span class="params">props: ISchemaFieldComponentProps</span>) =&gt;</span> React.ReactElement</span><br><span class="line">  ) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Field</span><br><span class="line">        path=&#123;path&#125;</span><br><span class="line">        <span class="comment">// ...省略其他属性的设置</span></span><br><span class="line">      &gt;</span><br><span class="line">        &#123;(&#123; state, mutators, form &#125;) =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> props: ISchemaFieldComponentProps = &#123;</span><br><span class="line">            ...state,</span><br><span class="line">            schema: <span class="keyword">new</span> Schema(fieldSchema).merge(state.props),</span><br><span class="line">            form,</span><br><span class="line">            mutators,</span><br><span class="line">            renderField</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> callback(props)</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      &lt;<span class="regexp">/Field&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">  const renderVirtualFieldDelegate = (</span></span><br><span class="line"><span class="regexp">    callback: (props: ISchemaVirtualFieldComponentProps) =&gt; React.ReactElement</span></span><br><span class="line"><span class="regexp">  ) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">      &lt;VirtualField</span></span><br><span class="line"><span class="regexp">        path=&#123;path&#125;</span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/ ...省略其他属性的设置</span></span><br><span class="line"><span class="regexp">      &gt;</span></span><br><span class="line"><span class="regexp">        &#123;(&#123; state, form &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">          const props: ISchemaVirtualFieldComponentProps = &#123;</span></span><br><span class="line"><span class="regexp">            ...state,</span></span><br><span class="line"><span class="regexp">            schema: new Schema(fieldSchema).merge(state.props),</span></span><br><span class="line"><span class="regexp">            form,</span></span><br><span class="line"><span class="regexp">            renderField,</span></span><br><span class="line"><span class="regexp">            children: fieldSchema.mapProperties(</span></span><br><span class="line"><span class="regexp">              (schema: Schema, key: string) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">                return (</span></span><br><span class="line"><span class="regexp">                  &lt;SchemaField</span></span><br><span class="line"><span class="regexp">                    schema=&#123;schema&#125;</span></span><br><span class="line"><span class="regexp">                    key=&#123;key&#125;</span></span><br><span class="line"><span class="regexp">                    path=&#123;path.concat(key)&#125;</span></span><br><span class="line"><span class="regexp">                  /</span>&gt;</span><br><span class="line">                )</span><br><span class="line">              &#125;</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> callback(props)</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      &lt;<span class="regexp">/VirtualField&gt;</span></span><br><span class="line"><span class="regexp">    )</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">  /</span><span class="regexp">/ object 类型，每个 kv 都是一个表单项，遍历生成 SchemaField 组件，插入到当前节点</span></span><br><span class="line"><span class="regexp">  if (fieldSchema.type === 'object' &amp;&amp; !schemaComponent) &#123;</span></span><br><span class="line"><span class="regexp">    const properties = fieldSchema.mapProperties(</span></span><br><span class="line"><span class="regexp">      (schema: Schema, key: string) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">        const childPath = path.concat(key)</span></span><br><span class="line"><span class="regexp">        return (</span></span><br><span class="line"><span class="regexp">          &lt;SchemaField</span></span><br><span class="line"><span class="regexp">            schema=&#123;schema&#125;</span></span><br><span class="line"><span class="regexp">            key=&#123;childPath.toString()&#125;</span></span><br><span class="line"><span class="regexp">            path=&#123;childPath&#125;</span></span><br><span class="line"><span class="regexp">          /</span>&gt;</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> renderFieldDelegate(<span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> renderComponent = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> React.createElement(</span><br><span class="line">          formRegistry.formItemComponent,</span><br><span class="line">          props,</span><br><span class="line">          properties</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isFn(schemaRenderer)) &#123;</span><br><span class="line">        <span class="keyword">return</span> schemaRenderer(&#123; ...props, renderComponent &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> renderComponent()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isStr(initialComponent)) &#123; <span class="comment">// schema 中配置的组件是字符串</span></span><br><span class="line">      <span class="keyword">if</span> (formRegistry.fields[initialComponent]) &#123;</span><br><span class="line">        <span class="comment">// 组件字符串对应表单组件，用 FormItem 包裹</span></span><br><span class="line">        <span class="keyword">return</span> renderFieldDelegate(<span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> stateComponent = lowercase(</span><br><span class="line">            props.schema.getExtendsComponent() || props.schema.type</span><br><span class="line">          )</span><br><span class="line">          <span class="keyword">const</span> renderComponent = (): React.ReactElement =&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> React.createElement(</span><br><span class="line">              formRegistry.formItemComponent,</span><br><span class="line">              props,</span><br><span class="line">              React.createElement(formRegistry.fields[stateComponent], props)</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (isFn(schemaRenderer)) &#123;</span><br><span class="line">            <span class="keyword">return</span> schemaRenderer(&#123; ...props, renderComponent &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> renderComponent()</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (formRegistry.virtualFields[initialComponent]) &#123;</span><br><span class="line">        <span class="comment">// 组件字符串对应虚拟组件，直接渲染</span></span><br><span class="line">        <span class="keyword">return</span> renderVirtualFieldDelegate(<span class="function"><span class="params">props</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> stateComponent = lowercase(</span><br><span class="line">            props.schema.getExtendsComponent() || props.schema.type</span><br><span class="line">          )</span><br><span class="line">          <span class="keyword">const</span> renderComponent = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> React.createElement(</span><br><span class="line">              formRegistry.virtualFields[stateComponent],</span><br><span class="line">              props</span><br><span class="line">            )</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (isFn(schemaRenderer)) &#123;</span><br><span class="line">            <span class="keyword">return</span> schemaRenderer(&#123; ...props, renderComponent &#125;)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> renderComponent()</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UI-组件层-formily-antd"><a href="#UI-组件层-formily-antd" class="headerlink" title="UI 组件层 - @formily/antd"></a>UI 组件层 - @formily/antd</h2><p>这一层主要负责借助 @formily/react-schema-renderer 提供的组件和能力，结合 antd 组件库，封装成带组件库的包。</p>
<h3 id="组件-2"><a href="#组件-2" class="headerlink" title="组件"></a>组件</h3><h4 id="概述-12"><a href="#概述-12" class="headerlink" title="概述"></a>概述</h4><p>由于封装的组件和透传的 API 很多，而且逻辑比较分散独立，这里不再一一介绍。以具有代表性的 Submit 组件为例，初步体会组件层的设计分工：结合三方组件库。</p>
<h4 id="源码分析-12"><a href="#源码分析-12" class="headerlink" title="源码分析"></a>源码分析</h4><p><strong>Submit</strong></p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; FormSpy &#125; <span class="keyword">from</span> <span class="string">'@formily/react-schema-renderer'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Button &#125; <span class="keyword">from</span> <span class="string">'antd'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 FormSpy 的基础上封装：内置 antd Button 组件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Submit = <span class="function">(<span class="params">&#123; showLoading, onSubmit, ...props &#125;: ISubmitProps</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;FormSpy</span><br><span class="line">      selector=&#123;[</span><br><span class="line">        LifeCycleTypes.ON_FORM_SUBMIT_START,</span><br><span class="line">        LifeCycleTypes.ON_FORM_SUBMIT_END</span><br><span class="line">      ]&#125;</span><br><span class="line">      reducer=&#123;(state, action) =&gt; &#123;</span><br><span class="line">        <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">          <span class="keyword">case</span> LifeCycleTypes.ON_FORM_SUBMIT_START:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">              ...state,</span><br><span class="line">              submitting: <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">          <span class="keyword">case</span> LifeCycleTypes.ON_FORM_SUBMIT_END:</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">              ...state,</span><br><span class="line">              submitting: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> state</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &#123;(&#123; state, form &#125;) =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          &lt;Button</span><br><span class="line">            onClick=&#123;e =&gt; &#123;</span><br><span class="line">              <span class="keyword">if</span> (props.htmlType !== <span class="string">'submit'</span>) &#123;</span><br><span class="line">                form.submit(onSubmit)</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (props.onClick) &#123;</span><br><span class="line">                props.onClick(e)</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;&#125;</span><br><span class="line">            disabled=&#123;showLoading ? state.submitting : <span class="literal">undefined</span>&#125;</span><br><span class="line">            &#123;...props&#125;</span><br><span class="line">            loading=&#123;showLoading ? state.submitting : <span class="literal">undefined</span>&#125;</span><br><span class="line">          &gt;</span><br><span class="line">            &#123;props.children || <span class="string">'提交'</span>&#125;</span><br><span class="line">          &lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">      &#125;&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>FormSpy&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line">Submit.defaultProps = &#123;</span><br><span class="line">  showLoading: <span class="literal">true</span>,</span><br><span class="line">  type: <span class="string">'primary'</span>,</span><br><span class="line">  htmlType: <span class="string">'submit'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Schema-编辑器层-formily-react-schema-editor"><a href="#Schema-编辑器层-formily-react-schema-editor" class="headerlink" title="Schema 编辑器层 - @formily/react-schema-editor"></a>Schema 编辑器层 - @formily/react-schema-editor</h2><blockquote>
<ul>
<li>Schema 编辑器层，这一层主要提供了可视化配置 Schema 能力，方便非技术人员快速配置表单</li>
</ul>
</blockquote>
<h3 id="体验"><a href="#体验" class="headerlink" title="体验"></a>体验</h3><p>之前没有使用过这个包，官方文档也没有任何说明。按照 README.md 用法使用，实际体验后，目前应该就是一个 json schema 编辑器，在同一个页面中提供了视图操作、直接编辑和预览效果的功能。但视图操作不好用，直接编辑没有高亮和错误提示，目前整体体验不好，期待以后的发展吧。</p>
<img src="/images/formily_schema.png" width="100%">

<h1 id="QA"><a href="#QA" class="headerlink" title="QA"></a>QA</h1><h2 id="路径系统-name（不包含虚拟表单项）-和-path（包含虚拟表单项）共存"><a href="#路径系统-name（不包含虚拟表单项）-和-path（包含虚拟表单项）共存" class="headerlink" title="路径系统 name（不包含虚拟表单项） 和 path（包含虚拟表单项）共存"></a>路径系统 name（不包含虚拟表单项） 和 path（包含虚拟表单项）共存</h2><h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><p>路径系统中存在 name 和 path，在寻找对应表单项时，可以根据 name 的规则来匹配，也可以根据 path 的规则来匹配。如下图：</p>
<img src="/images/formily_qa_1.png" width="100%">

<h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>对于路径系统中 name 和 path 均可使用的设计，开发者可能会存在疑问。下面尝试分析原因：<br>首先，根据 Form 实例的 registerField 方法，可以看到 FormGraph 和 FormValidator 实例的 key 都是 nodePath，即包含虚拟表单项的路径。可以理解对于 Formily 内部来说，path 是保持内部机制正常运作的重要路径。(补充，dataPath，即一般不包含虚拟表单项的路径，会作为 FormState 实例中 values 属性的路径，也充分表达了其数据路径的含义 ，代码在 registerVirtualField 部分有列出)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerField</span>(<span class="params">&#123;path, name&#125;</span>): <span class="title">IField</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> field: IField</span><br><span class="line">  <span class="keyword">const</span> nodePath = FormPath.parse(path || name) <span class="comment">// 路径，包含虚拟表单项</span></span><br><span class="line">  <span class="keyword">const</span> dataPath = transformDataPath(nodePath)  <span class="comment">// 数据路径，一般不包含虚拟表单项（除非匹配的表单项本身是虚拟表单项）</span></span><br><span class="line">  <span class="keyword">const</span> createField = <span class="function">(<span class="params">field?: IField</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> alreadyHaveField = !!field</span><br><span class="line">    field =</span><br><span class="line">      field ||</span><br><span class="line">      <span class="keyword">new</span> FieldState(&#123;</span><br><span class="line">        nodePath,</span><br><span class="line">        dataPath,</span><br><span class="line">        <span class="comment">// ...省略</span></span><br><span class="line">      &#125;)</span><br><span class="line">    field.subscription = &#123;</span><br><span class="line">      notify: onFieldChange(&#123; field, <span class="attr">path</span>: nodePath &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    heart.publish(LifeCycleTypes.ON_FIELD_WILL_INIT, field)</span><br><span class="line">    <span class="keyword">if</span> (!alreadyHaveField) &#123;</span><br><span class="line">      graph.appendNode(nodePath, field)</span><br><span class="line">    &#125;</span><br><span class="line">    validator.register(nodePath, validate =&gt; &#123;</span><br><span class="line">      <span class="comment">// ...省略</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> field</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (graph.exist(nodePath)) &#123;</span><br><span class="line">    <span class="comment">// ...省略</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    field = createField()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> field</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，再观察 FieldState 构造函数，可以看到 FieldState 实例的 state.name 属性根据 dataPath 计算，最终一般不包含虚拟表单项（除非匹配的表单项本身是虚拟表单项）；state.path 属性根据 nodePath 计算，最终包含虚拟表单项。关于修改这点的原因，是因为开发者需求，详见 <a href="https://github.com/alibaba/formily/issues/543" target="_blank" rel="noopener">issues543</a>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> FieldState = createStateModel&lt;IFieldState, IFieldStateProps&gt;(</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">FieldState</span> </span>&#123;</span><br><span class="line">    private state: IFieldState</span><br><span class="line">    private nodePath: FormPath</span><br><span class="line">    private dataPath: FormPath</span><br><span class="line">    <span class="keyword">constructor</span>(state: IFieldState, props: IFieldStateProps) &#123;</span><br><span class="line">      <span class="keyword">this</span>.state = state</span><br><span class="line">      <span class="keyword">this</span>.nodePath = FormPath.getPath(props.nodePath)</span><br><span class="line">      <span class="keyword">this</span>.dataPath = FormPath.getPath(props.dataPath)</span><br><span class="line">      <span class="keyword">this</span>.state.name = <span class="keyword">this</span>.dataPath.entire</span><br><span class="line">      <span class="keyword">this</span>.state.path = <span class="keyword">this</span>.nodePath.entire</span><br><span class="line">      <span class="keyword">this</span>.state.dataType = props.dataType || <span class="string">'any'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此，猜测路径系统中 name 和 path 的并存的原因在于：内部主要是根据 path 存储和计算的，但是为了方便开发者理解和使用，增加了 name，只关注数据路径，忽略无意义的虚拟表单项路径。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/formily/" rel="tag"># formily</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/09/11/autotest/" rel="next" title="自动化测试">
                <i class="fa fa-chevron-left"></i> 自动化测试
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Freezer</p>
              <p class="site-description motion-element" itemprop="description">个人博客</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#架构篇"><span class="nav-number">1.</span> <span class="nav-text">架构篇</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#架构设计"><span class="nav-number">1.1.</span> <span class="nav-text">架构设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#架构实践"><span class="nav-number">1.2.</span> <span class="nav-text">架构实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备"><span class="nav-number">1.2.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#全量的-Dependency-Graph"><span class="nav-number">1.2.2.</span> <span class="nav-text">全量的 Dependency Graph</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代表性的-Dependency-Graph"><span class="nav-number">1.2.3.</span> <span class="nav-text">代表性的 Dependency Graph</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实现篇"><span class="nav-number">2.</span> <span class="nav-text">实现篇</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基础库-formily-shared"><span class="nav-number">2.1.</span> <span class="nav-text">基础库 - @formily/shared</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#路径定位系统-FormPath"><span class="nav-number">2.1.1.</span> <span class="nav-text">路径定位系统 - FormPath</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#校验库-formily-validator"><span class="nav-number">2.2.</span> <span class="nav-text">校验库 - @formily/validator</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#校验系统-FormValidator"><span class="nav-number">2.2.1.</span> <span class="nav-text">校验系统 - FormValidator</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#单元测试"><span class="nav-number">2.2.1.3.</span> <span class="nav-text">单元测试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心库-formily-core"><span class="nav-number">2.3.</span> <span class="nav-text">核心库 - @formily/core</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#事件系统-FormLifeCycle"><span class="nav-number">2.3.1.</span> <span class="nav-text">事件系统 - FormLifeCycle</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-1"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析-1"><span class="nav-number">2.3.1.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事件系统-FormHeart"><span class="nav-number">2.3.2.</span> <span class="nav-text">事件系统 - FormHeart</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-2"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析-2"><span class="nav-number">2.3.2.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态系统-FormGraph"><span class="nav-number">2.3.3.</span> <span class="nav-text">状态系统 - FormGraph</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-3"><span class="nav-number">2.3.3.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析-3"><span class="nav-number">2.3.3.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#状态系统-FormState、FieldState、VirtualFieldState"><span class="nav-number">2.3.4.</span> <span class="nav-text">状态系统 - FormState、FieldState、VirtualFieldState</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-4"><span class="nav-number">2.3.4.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析-4"><span class="nav-number">2.3.4.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表单-API-创建表单实例"><span class="nav-number">2.3.5.</span> <span class="nav-text">表单 API - 创建表单实例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-5"><span class="nav-number">2.3.5.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析-5"><span class="nav-number">2.3.5.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表单-API-注册表单项"><span class="nav-number">2.3.6.</span> <span class="nav-text">表单 API - 注册表单项</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-6"><span class="nav-number">2.3.6.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析-6"><span class="nav-number">2.3.6.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表单-API-读写表单状态"><span class="nav-number">2.3.7.</span> <span class="nav-text">表单 API - 读写表单状态</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-7"><span class="nav-number">2.3.7.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析-7"><span class="nav-number">2.3.7.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表单-API-监听表单更新"><span class="nav-number">2.3.8.</span> <span class="nav-text">表单 API - 监听表单更新</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-8"><span class="nav-number">2.3.8.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析-8"><span class="nav-number">2.3.8.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#表单-API-表单校验和提交"><span class="nav-number">2.3.9.</span> <span class="nav-text">表单 API - 表单校验和提交</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-9"><span class="nav-number">2.3.9.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析-9"><span class="nav-number">2.3.9.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UI-桥接层-formily-react"><span class="nav-number">2.4.</span> <span class="nav-text">UI 桥接层 - @formily/react</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#组件"><span class="nav-number">2.4.1.</span> <span class="nav-text">组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-10"><span class="nav-number">2.4.1.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析-10"><span class="nav-number">2.4.1.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Schema-动态渲染层-formily-react-schema-renderer"><span class="nav-number">2.5.</span> <span class="nav-text">Schema 动态渲染层 - @formily/react-schema-renderer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#组件-1"><span class="nav-number">2.5.1.</span> <span class="nav-text">组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-11"><span class="nav-number">2.5.1.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析-11"><span class="nav-number">2.5.1.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UI-组件层-formily-antd"><span class="nav-number">2.6.</span> <span class="nav-text">UI 组件层 - @formily/antd</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#组件-2"><span class="nav-number">2.6.1.</span> <span class="nav-text">组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#概述-12"><span class="nav-number">2.6.1.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析-12"><span class="nav-number">2.6.1.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Schema-编辑器层-formily-react-schema-editor"><span class="nav-number">2.7.</span> <span class="nav-text">Schema 编辑器层 - @formily/react-schema-editor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#体验"><span class="nav-number">2.7.1.</span> <span class="nav-text">体验</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#QA"><span class="nav-number">3.</span> <span class="nav-text">QA</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#路径系统-name（不包含虚拟表单项）-和-path（包含虚拟表单项）共存"><span class="nav-number">3.1.</span> <span class="nav-text">路径系统 name（不包含虚拟表单项） 和 path（包含虚拟表单项）共存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#用法"><span class="nav-number">3.1.1.</span> <span class="nav-text">用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#原因"><span class="nav-number">3.1.2.</span> <span class="nav-text">原因</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Freezer</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
